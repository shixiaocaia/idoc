<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内存管理 iDoc</title>
    <meta name="description" content="静态内存用来保存局部static对象、类static数据成员、定义在任何函数之外的变量。">
    <meta name="keywords" content="notebook">
    <link rel="stylesheet" type="text/css" href="../css/main.css?v=1.21.13">
    <link rel="stylesheet" type="text/css" href="../css/tocbot.css?v=1.21.13">
    <link rel="stylesheet" type="text/css" href="../css/media.css?v=1.21.13">
    <link rel="stylesheet" type="text/css" href="../css/sidebar.css?v=1.21.13">
    <link rel="stylesheet" type="text/css" href="../css/copy.css?v=1.21.13">
    <link rel="icon" href="../logo.png" type="image/x-icon">
    <script src="../js/copy.js?v=1.21.13"></script>
    <script src="../js/dark-mode.js?v=1.21.13"></script>
    <script src="../js/markdown-style.js?v=1.21.13"></script>
  </head>
  <body id="idoctotop"><a href="#idoctotop" class="gototop">top</a>
    <header class="header">
      <article class="inner warpper"><a class="logo" href="../index.html"><img alt="iDoc logo" src="../logo.png">
<span class="title">iDoc</span></a>
        <div class="content">
          <ul class="menu">
            <li><a href="../index.html" target="" class="">Home</a></li>
            <li><a href="index.html" target="" class="active">Cpp</a></li>
            <li><a href="../01DataStructure/index.html" target="" class="">DataStructure</a></li>
            <li><a href="../01OperatingSystem/index.html" target="" class="">OperatingSystem</a></li>
            <li><a href="../01ComputerNetwork/index.html" target="" class="">ComputerNetwrok</a></li>
            <li><a href="../01DataBase/index.html" target="" class="">DataBase</a></li>
            <li><a href="../02MyWeb/index.html" target="" class="">Webserver</a></li>
            <li><a href="../00Other/index.html" target="" class="">Other</a></li>
          </ul><a href="https://github.com/shixiaocaia" target="_blank" rel="noopener noreferrer" title="Github" name="Github" class="github"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
            </svg></a>
          <dark-mode permanent=""></dark-mode>
        </div>
      </article>
    </header>
    <div class="warpper-content warpper sidebar">
      <div class="sidebar-border">
        <aside class="sidebar" role="navigation">
          <div>
            <a href="index.html" class="">↩️README</a>
            <label>C++ primer</label>
            <a href="ch00.html" class="">语法问题</a>
            <a href="ch01.html" class="">指针&#x26;引用</a>
            <a href="ch02.html" class="">函数</a>
            <a href="ch03.html" class="">类</a>
            <a href="ch10.html" class="">模板</a>
            <a href="ch15.html" class="">异常处理</a>
            <a href="ch16.html" class="">内存管理</a>
            <label>STL</label>
            <a href="ch20.html" class="">标准库</a>
            <a href="ch21.html" class="">容器</a>
            <label>读万里书</label>
            <a href="ch31.html" class="">Effective C++</a>
          </div>
        </aside>
      </div>
      <markdown-style>
        <h1 id="内存管理"><a aria-hidden="true" tabindex="-1" href="#内存管理" class="anchor"><span class="icon icon-link"></span></a>内存管理</h1>
        <p>静态内存用来保存局部static对象、类static数据成员、定义在任何函数之外的变量。</p>
        <p>栈内存用来保存定义在函数内的非static对象。</p>
        <blockquote>
          <p>分配在静态内存或者栈内存中的对象由编译器自动创建和销毁。</p>
        </blockquote>
        <p>每个程序还拥有一个内存池，这部分内存被称作<strong>自由空间（free store)或者堆（heap）</strong>。</p>
        <blockquote>
          <p>程序用堆来存储动态分配的对象，动态对象的生命周期由程序控制，销毁需要手动显示销毁。</p>
        </blockquote>
        <p><strong>智能指针</strong></p>
        <p>管理动态对象，自动释放所指向的对象。</p>
        <pre class="language-cpp"><code class="language-cpp code-highlight"><span class="code-line line-number" line="1"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&#x3C;memory></span></span>
</span><span class="code-line line-number" line="2">shared_ptr 允许多个指针指向同一个对象
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">unique_ptr 独占所指向的对象
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6">weak_ptr 指向shared_ptr所指向的对象，是一种弱引用。
</span></code><input type="hidden" value="#include<memory>
shared_ptr 允许多个指针指向同一个对象

unique_ptr 独占所指向的对象

weak_ptr 指向shared_ptr所指向的对象，是一种弱引用。
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h3 id="为什么使用动态内存"><a aria-hidden="true" tabindex="-1" href="#为什么使用动态内存" class="anchor"><span class="icon icon-link"></span></a>为什么使用动态内存</h3>
        <ol>
          <li>允许多个对象共享相同的状态</li>
        </ol>
        <blockquote>
          <p>比如当变量b2 拷贝 b1, b2 = b1, 不能直接析构b2，因为b1还在使用。</p>
        </blockquote>
        <h3 id="内存泄漏"><a aria-hidden="true" tabindex="-1" href="#内存泄漏" class="anchor"><span class="icon icon-link"></span></a>内存泄漏</h3>
        <p>在函数返回一个非智能指针时，在函数作用域结束时，没用销毁其内存，会造成内存的泄露问题，这需要函数调用者显示销毁内存。</p>
        <p>当多个指针对象指向同一个内存内容时，如果进行多次释放，会破坏自由空间。</p>
        <h3 id="shared_ptr"><a aria-hidden="true" tabindex="-1" href="#shared_ptr" class="anchor"><span class="icon icon-link"></span></a>shared_ptr</h3>
        <p><strong>创建动态对象</strong></p>
        <p>最安全的分配和使用动态内存的方法，调用<code>make_shared</code>函数。</p>
        <pre class="language-cpp"><code class="language-cpp code-highlight"><span class="code-line line-number" line="1">shared_ptr<span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token operator">></span>p3 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">auto</span> p6 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&#x3C;</span>vector<span class="token operator">&#x3C;</span>string<span class="token operator">>></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code><input type="hidden" value="shared_ptr<int>p3 = make_shared<int>(42);
auto p6 = make_shared<vector<string>>();
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <p><strong>拷贝和赋值</strong></p>
        <p>当进行拷贝或赋值操作时，每个shared ptr都会记录有多少个其他shared_ptr指向相同的对象。</p>
        <pre class="language-cpp"><code class="language-cpp code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">auto</span> r <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="2">r <span class="token operator">=</span> q<span class="token punctuation">;</span> 
</span></code><input type="hidden" value="auto r = make_shared<int>(42);
r = q; 
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <p>给r赋值，那么r原来指向的对象的引用计数 - 1，如果r原来指向的对象已经没有引用者了（引用计数为0），那么会自动释放这个对象。</p>
        <p><strong>析构</strong></p>
        <p>当指向一个对象的最后一个shared ptr被销毁时，shared ptr类会自动销毁此对象。它是通过另一个特殊的成员函数析构函数(destructor)完成销毁工作的。</p>
        <p><strong>空悬指针</strong></p>
        <p>delete一个指针后，虽然对应的内存空间已经释放，但是该指针仍然会指向曾经存放内容的地址，称为空悬指针。</p>
        <p>解决这样的方式，<code>p = nullptr;</code></p>
        <p><strong>shared_ptr 和new结合使用</strong></p>
        <pre class="language-cpp"><code class="language-cpp code-highlight"><span class="code-line line-number" line="1">shared_ptr<span class="token operator">&#x3C;</span><span class="token keyword">double</span><span class="token operator">></span> p1<span class="token punctuation">;</span> <span class="token comment">//p1指向一个double，初始化为空指针</span>
</span><span class="code-line line-number" line="2">shared_ptr<span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">p2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//p2指向一个值为42的int</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">shared_ptr<span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token operator">></span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//不能通过隐式转换，必须像p2一样显示初始化</span>
</span><span class="code-line line-number" line="5">
</span></code><input type="hidden" value="shared_ptr<double> p1; //p1指向一个double，初始化为空指针
shared_ptr<int> p2(new int(42));//p2指向一个值为42的int

shared_ptr<int> p3 = new int(42); //不能通过隐式转换，必须像p2一样显示初始化

"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <p><strong>也不要使用get初始化另一个智能指针或为智能指针赋值</strong></p>
        <p>智能指针定义了一个名为get的函数，返回一个内置指针（普通指针），指向智能指针管理的对象。</p>
        <p>get函数是为了向不需要使用智能指针的代码传递一个内置指针，使用get返回指针的代码<strong>不能delete</strong>此指针，否则会导致原智能指针被释放。</p>
        <blockquote>
          <p>不使用相同的内置指针值初始化(或reset)多个智能指针。</p>
          <p>不delete get（）返回的指针。</p>
          <p>不使用get（）初始化或reset另一个智能指针。</p>
          <p>如果你使用get（）返回的指针，记住当最后一个对应的智能指针销毁后，你的指针就变为无效了。</p>
          <p>如果你使用智能指针管理的资源不是new分配的内存，记住传递给它一个删除器。</p>
        </blockquote>
        <p><strong>传递删减器</strong></p>
        <h3 id="unique_ptr"><a aria-hidden="true" tabindex="-1" href="#unique_ptr" class="anchor"><span class="icon icon-link"></span></a>unique_ptr</h3>
        <p>与shared_ptr不同，某个时刻只能有一个unique_ptr指向一个给定对象，当unique_ptr被释放时，它所指向的对象也被销毁。</p>
        <p>不能拷贝和赋值，这是一种“独占所有权”。</p>
        <p><strong>初始化</strong></p>
        <pre class="language-cpp"><code class="language-cpp code-highlight"><span class="code-line line-number" line="1">unique_ptr<span class="token operator">&#x3C;</span>string<span class="token operator">></span> <span class="token function">p1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//只能使用直接初始化的方式</span>
</span><span class="code-line line-number" line="2">unique_ptr<span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">p2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">unique_ptr<span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">p3</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//error，不支持拷贝</span>
</span><span class="code-line line-number" line="5">unique_ptr<span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token operator">></span> p4<span class="token punctuation">;</span>
</span><span class="code-line line-number" line="6">p4 <span class="token operator">=</span> p1<span class="token punctuation">;</span><span class="token comment">//error,不支持赋值</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token comment">//将所有权从p1(指向string Stegosaurus)转移给p2</span>
</span><span class="code-line line-number" line="9">unique_ptr<span class="token operator">&#x3C;</span>string<span class="token operator">></span><span class="token function">p2</span><span class="token punctuation">(</span>pl<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//release将pl置为空</span>
</span><span class="code-line line-number" line="10">unique_ptr<span class="token operator">&#x3C;</span>string<span class="token operator">></span><span class="token function">p3</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span> <span class="token punctuation">(</span><span class="token string">"Trex"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="11"><span class="token comment">//将所有权从p3转移给P2</span>
</span><span class="code-line line-number" line="12">p2<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>p3<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//reset释放了p2原来指向的内存</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">p2<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//error, p2不会释放内存，但我们丢失了指针</span>
</span><span class="code-line line-number" line="15"><span class="token keyword">auto</span> p <span class="token operator">=</span> p2<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="16"><span class="token keyword">delete</span> p<span class="token punctuation">;</span>
</span></code><input type="hidden" value="unique_ptr<string> p1(new string(&#x22;Hello world!&#x22;)); //只能使用直接初始化的方式
unique_ptr<int> p2(new int(42));

unique_ptr<int> p3(p2); //error，不支持拷贝
unique_ptr<int> p4;
p4 = p1;//error,不支持赋值

//将所有权从p1(指向string Stegosaurus)转移给p2
unique_ptr<string>p2(pl.release()); //release将pl置为空
unique_ptr<string>p3(new string (&#x22;Trex&#x22;));
//将所有权从p3转移给P2
p2.reset(p3.release());//reset释放了p2原来指向的内存

p2.release(); //error, p2不会释放内存，但我们丢失了指针
auto p = p2.release();
delete p;
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <p><strong>传递和返回unique_ptr</strong></p>
        <p>不能拷贝和赋值unique_ptr，但是能够拷贝和赋值一个将要销毁的unique_ptr，最常见的例子是在从函数返回时拷贝或者赋值一个unique_ptr。</p>
        <pre><code class="language-cpp\ code-highlight"><span class="code-line line-number" line="1">return unique_ptr&#x3C;int>(new int(p));
</span></code><input type="hidden" value="return unique_ptr<int>(new int(p));
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <p><strong>传递删减器</strong></p>
        <p>默认情况下使用delete释放所指向的对象。</p>
        <pre class="language-cpp"><code class="language-cpp code-highlight"><span class="code-line line-number" line="1"><span class="token comment">//p指向一个类型为objT的对象，并使用一个类型为de1T的对象释放objT对象</span>
</span><span class="code-line line-number" line="2"><span class="token comment">//它会调用一个名为fcn的delT类型对象</span>
</span><span class="code-line line-number" line="3">unique_ptr<span class="token operator">&#x3C;</span>objT<span class="token punctuation">,</span>delT<span class="token operator">></span><span class="token function">p</span> <span class="token punctuation">(</span><span class="token keyword">new</span> objT<span class="token punctuation">,</span>fcn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code><input type="hidden" value="//p指向一个类型为objT的对象，并使用一个类型为de1T的对象释放objT对象
//它会调用一个名为fcn的delT类型对象
unique_ptr<objT,delT>p (new objT,fcn);
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h3 id="weak_ptr"><a aria-hidden="true" tabindex="-1" href="#weak_ptr" class="anchor"><span class="icon icon-link"></span></a>weak_ptr</h3>
        <p>“弱”指针。</p>
        <p>weak_ptr是一种不控制所指向对象生存周期的指针，它指向一个shared_ptr管理的对象。将一个weak_ptr绑定到一个shared_ptr，不会改变其绑定的shared_ptr的引用计数。</p>
        <p><strong>初始化</strong></p>
        <pre class="language-cpp"><code class="language-cpp code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">auto</span> p <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="2">weak_ptr<span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">wp</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="3"><span class="token comment">//wp 弱共享p，p的计数未变。</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token keyword">if</span> <span class="token punctuation">(</span>shared_ptr<span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token operator">></span> np <span class="token operator">=</span> wp<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="6">    
</span><span class="code-line line-number" line="7"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="8"><span class="token comment">//由于weak_ptr无法控制对象是否存在，必须用lock函数检查weak_ptr指向的对象是否存在。</span>
</span><span class="code-line line-number" line="9"><span class="token comment">//如果存在返回一个指向共享对象的shared_ptr</span>
</span></code><input type="hidden" value="auto p = make_shared<int>(42);
weak_ptr<int> wp(p);
//wp 弱共享p，p的计数未变。

if (shared_ptr<int> np = wp.lock()){
    
}
//由于weak_ptr无法控制对象是否存在，必须用lock函数检查weak_ptr指向的对象是否存在。
//如果存在返回一个指向共享对象的shared_ptr
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h2 id="动态数组"><a aria-hidden="true" tabindex="-1" href="#动态数组" class="anchor"><span class="icon icon-link"></span></a>动态数组</h2>
        <blockquote>
          <p>[!NOTE]</p>
          <p>动态数组不是数组类型，这是很重要的。</p>
        </blockquote>
        <h3 id="创建动态数组"><a aria-hidden="true" tabindex="-1" href="#创建动态数组" class="anchor"><span class="icon icon-link"></span></a>创建动态数组</h3>
        <pre class="language-cpp"><code class="language-cpp code-highlight"><span class="code-line line-number" line="1"><span class="token comment">//调用get_size 确定分配多少个int</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">int</span> <span class="token operator">*</span>pia <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token function">get_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="3"><span class="token comment">//方括号内的大小必须是整型的，但不必是常量</span>
</span></code><input type="hidden" value="//调用get_size 确定分配多少个int
int *pia = new int[get_size()];
//方括号内的大小必须是整型的，但不必是常量
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h3 id="初始化"><a aria-hidden="true" tabindex="-1" href="#初始化" class="anchor"><span class="icon icon-link"></span></a>初始化</h3>
        <pre class="language-cpp"><code class="language-cpp code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">int</span> <span class="token operator">*</span>pia <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//10个未初始化的int</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">int</span> <span class="token operator">*</span>pia2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10个值初始化为0的int</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">string <span class="token operator">*</span>psa <span class="token operator">=</span> <span class="token keyword">new</span> string<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="5">string <span class="token operator">*</span>psa <span class="token operator">=</span> <span class="token keyword">new</span> string<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7">string <span class="token operator">*</span>psa <span class="token operator">=</span> <span class="token keyword">new</span> string<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"an"</span><span class="token punctuation">,</span> <span class="token string">"the"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></code><input type="hidden" value="int *pia = new int[10]; //10个未初始化的int
int *pia2 = new int[10](); // 10个值初始化为0的int

string *psa = new string[10];
string *psa = new string[10]();

string *psa = new string[10]{&#x22;a&#x22;, &#x22;an&#x22;, &#x22;the&#x22;};
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h3 id="释放动态数组"><a aria-hidden="true" tabindex="-1" href="#释放动态数组" class="anchor"><span class="icon icon-link"></span></a>释放动态数组</h3>
        <pre class="language-cpp"><code class="language-cpp code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">delete</span> p<span class="token punctuation">;</span> <span class="token comment">//p必须指向一个动态分配的对象或为空</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> pa<span class="token punctuation">;</span> <span class="token comment">// pa必须指向一个动态分配的数组或为空</span>
</span></code><input type="hidden" value="delete p; //p必须指向一个动态分配的对象或为空
delete [] pa; // pa必须指向一个动态分配的数组或为空
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <blockquote>
          <p>方括号是必须的，它指示编译器此指针指向的一个对象数组的第一个元素，否则行为是未定义。</p>
          <p>如果少一个方括号，可能编译器没有任何提示。</p>
        </blockquote>
        <h3 id="智能指针和动态数组"><a aria-hidden="true" tabindex="-1" href="#智能指针和动态数组" class="anchor"><span class="icon icon-link"></span></a>智能指针和动态数组</h3>
        <pre class="language-cpp"><code class="language-cpp code-highlight"><span class="code-line line-number" line="1">unique_ptr<span class="token operator">&#x3C;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="2">up<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code><input type="hidden" value="unique_ptr<int[]> up(new int[10]);
up.release();
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <p>标准库提供了一个可以管理new分配的数组的<code>unique_ptr</code>版本。为了用一个<code>unique_ptr</code>管理动态数组，我们必须在对象类型后面跟一对空方括号。</p>
        <p><code>shared_ptr</code>不提供删除器，要使用的话要自定义删除器。</p>
        <p>同时<code>unique_ptr</code>不支持下标运算符。</p>
        <h3 id="allocator类"><a aria-hidden="true" tabindex="-1" href="#allocator类" class="anchor"><span class="icon icon-link"></span></a>allocator类</h3>
        <p>实现内存分配和对象构造的分离。</p>
      </markdown-style>
      <nav class="tocs">
        <aside class="inner toc">
          <ol class="tocs-list">
            <li><a href="#为什么使用动态内存" class="tocs-link">为什么使用动态内存</a></li>
            <li><a href="#内存泄漏" class="tocs-link">内存泄漏</a></li>
            <li><a href="#shared_ptr" class="tocs-link">shared_ptr</a></li>
            <li><a href="#unique_ptr" class="tocs-link">unique_ptr</a></li>
            <li><a href="#weak_ptr" class="tocs-link">weak_ptr</a></li>
          </ol>
        </aside>
      </nav>
    </div>
    <script src="../js/demo-preview.js?v=1.21.13"></script>
    <div class="footer warpper">Created by <a href="https://github.com/shixiaocaia" target="_blank">shixiaocaia</a> | Powered by <a href="https://github.com/jaywcjlove/idoc" target="_blank">idoc</a><br>Think less and do more.</div>
    <script src="../js/tocbot.js?v=1.21.13"></script>
  </body>
</html>
