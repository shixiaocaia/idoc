<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go并发编程 iDoc</title>
    <meta name="description" content="IO 密集型服务的瓶颈不在 CPU 处理速度，而在于尽可能快速的完成高并发、多连接下的数据读写。">
    <meta name="keywords" content="notebook">
    <link rel="stylesheet" type="text/css" href="../css/main.css?v=1.25.0">
    <link rel="stylesheet" type="text/css" href="../css/tocbot.css?v=1.25.0">
    <link rel="stylesheet" type="text/css" href="../css/media.css?v=1.25.0">
    <link rel="stylesheet" type="text/css" href="../css/sidebar.css?v=1.25.0">
    <link rel="stylesheet" type="text/css" href="../css/copy.css?v=1.25.0">
    <link rel="stylesheet" type="text/css" href="../css/fancybox.css?v=1.25.0">
    <link rel="icon" href="../logo.png" type="image/x-icon">
    <script src="../js/copy.js?v=1.25.0"></script>
    <script src="../js/dark-mode.js?v=1.25.0"></script>
    <script src="../js/markdown-style.js?v=1.25.0"></script>
    <script src="../js/jquery.min.js?v=1.25.0"></script>
    <script src="../js/fancybox.umd.js?v=1.25.0"></script>
  </head>
  <body><button onclick="topFunction()" id="myBtn" title="Go to top">Top</button>
    <script>
// Get the button:
let mybutton = document.getElementById("myBtn");
// When the user scrolls down 20px from the top of the document, show the button
window.onscroll = function() {scrollFunction()};
// 顶部隐藏，底部隐藏
function scrollFunction() {
if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
mybutton.style.display = "block";
} else {
mybutton.style.display = "none";
}
}
// When the user clicks on the button, scroll to the top of the document
function topFunction() {
document.body.scrollTop = 0; // For Safari
document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
}
</script>
    <header class="header">
      <article class="inner warpper"><a class="logo" href="../index.html"><img alt="iDoc logo" src="../logo.png">
<span class="title">iDoc</span></a>
        <div class="content">
          <ul class="menu">
            <li><a href="../index.html" target="" class="">Home</a></li>
            <li><a href="index.html" target="" class="active">Go</a></li>
            <li><a href="../01DataStructure/index.html" target="" class="">DataStructure</a></li>
            <li><a href="../01ComputerNetwork/index.html" target="" class="">ComputerNetwrok</a></li>
            <li><a href="../01DataBase/index.html" target="" class="">DataBase</a></li>
            <li><a href="../01OperatingSystem/index.html" target="" class="">OperatingSystem</a></li>
            <li><a href="../03Other/index.html" target="" class="">Other</a></li>
          </ul><a href="https://github.com/shixiaocaia" target="_blank" rel="noopener noreferrer" title="Github" name="Github" class="github"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
            </svg></a>
          <dark-mode permanent=""></dark-mode>
        </div>
      </article>
    </header>
    <div class="warpper-content warpper sidebar">
      <div class="sidebar-border">
        <aside class="sidebar" role="navigation">
          <div>
            <a href="index.html" class="">↩️README</a>
            <label>Hello World</label>
            <a href="ch00.html" class="">配个环境</a>
            <a href="ch04.html" class="">Go Moudle</a>
            <a href="ch01.html" class="">基础语法</a>
            <a href="ch02.html" class="">并发编程</a>
            <label>Web编程</label>
            <a href="ch03.html" class="">gorm框架</a>
            <a href="ch05.html" class="">gin框架</a>
          </div>
        </aside>
      </div>
      <markdown-style>
        <h1 id="go并发编程"><a aria-hidden="true" tabindex="-1" href="#go并发编程" class="anchor"><span class="icon icon-link"></span></a>Go并发编程</h1>
        <h2 id="前置知识"><a aria-hidden="true" tabindex="-1" href="#前置知识" class="anchor"><span class="icon icon-link"></span></a>前置知识</h2>
        <h3 id="并发并行"><a aria-hidden="true" tabindex="-1" href="#并发并行" class="anchor"><span class="icon icon-link"></span></a>并发、并行</h3>
        <ul>
          <li>
            <p>并发：在并发中，这些任务可以在同一个时间段内<strong>交替执行</strong>，每个任务都有可能在任意时刻被暂停或切换，以便给其他任务执行的机会。并发可以提高系统的吞吐量和资源利用率，但并不一定意味着同时进行多个任务的实际并行执行。</p>
            <ul>
              <li>需要多核CPU支持。</li>
            </ul>
          </li>
          <li>
            <p>并行：指系统中多个任务同时进行实际的并发执行，每个任务都有自己的执行线程或处理器核心。在并行中，多个任务可以<strong>同时进行</strong>，彼此之间<strong>相互独立</strong>，互不干扰。并行可以通过多核处理器、分布式系统等实现，以提高任务的执行速度和效率。</p>
          </li>
        </ul>
        <h3 id="同步异步"><a aria-hidden="true" tabindex="-1" href="#同步异步" class="anchor"><span class="icon icon-link"></span></a>同步、异步</h3>
        <ul>
          <li>同步：执行一个操作之后，等待结果，然后才继续执行后续的操作。操作之间有顺序要求，是一种线性执行的方式。</li>
          <li>异步：执行一个操作后，可以去执行其他的操作，然后等待通知再回来执行刚才没执行完的操作。操作之间没有顺序要求，是一种并行处理的方式。</li>
        </ul>
        <h3 id="进程"><a aria-hidden="true" tabindex="-1" href="#进程" class="anchor"><span class="icon icon-link"></span></a>进程</h3>
        <ul>
          <li>进程是程序执行的过程，包括了动态创建、调度和消亡的整个过程，进程是操作系统<strong>分配</strong>资源的基本单位</li>
          <li>进程通常管理包括内存资源、IO资源、信号处理等部分。
            <ul>
              <li>内存管理，采用虚拟内存技术，把进程虚拟地址空间划分成<strong>用户空间和内核空间</strong>。</li>
            </ul>
          </li>
        </ul>
        <h3 id="线程"><a aria-hidden="true" tabindex="-1" href="#线程" class="anchor"><span class="icon icon-link"></span></a>线程</h3>
        <ul>
          <li>线程是操作操作系统能够进行运算调度的最小单位。<strong>线程被包含在进程之中</strong>，是进程中的实际运作单位，一个进程内可以包含多个线程，线程是资源调度的最小单位。</li>
          <li>同一进程中的多条线程共享该进程中的全部系统资源，如虚拟地址空间，文件描述符文件描述符和信号处理等等。</li>
          <li>同一进程中的多个线程有各自的调用栈、寄存器环境、线程本地存储等信息。</li>
          <li>线程间切换
            <ul>
              <li>线程是被内核所调度，线程被调度切换到另一个线程上下文的时候，需要保存一个用户线程的状态到内存</li>
              <li>恢复另一个线程状态到寄存器，然后更新调度器的数据结构，这几步操作涉及<strong>用户态到内核态转换</strong>，开销比较多。</li>
            </ul>
          </li>
        </ul>
        <h3 id="协程"><a aria-hidden="true" tabindex="-1" href="#协程" class="anchor"><span class="icon icon-link"></span></a>协程</h3>
        <p>IO 密集型服务的瓶颈不在 CPU 处理速度，而在于尽可能快速的完成高并发、多连接下的数据读写。</p>
        <ul>
          <li>如果用多线程，高并发场景的大量 IO 等待会导致多线程被频繁挂起和切换，非常消耗系统资源，同时多线程访问共享资源存在竞争问题。</li>
          <li>如果用多进程，不仅存在频繁调度切换问题，同时还会存在每个进程资源不共享的问题，需要额外引入进程间通信机制来解决。</li>
        </ul>
        <p>协程 Coroutines 是一种比线程更加轻量级的<strong>微线程</strong>，<strong>用户态线程</strong>。类比一个进程可以拥有多个线程，一个线程也可以拥有多个协程，因此协程又称微线程和纤程。</p>
        <p>协程有独立的栈空间，但是共享堆空间</p>
        <ul>
          <li>协程间切换
            <ul>
              <li>调度完全由用户控制，协程拥有自己的寄存器上下文和栈，协程调度切换时，将寄存器上下文和栈保存到其他地方</li>
              <li>在切回来的时候，恢复先前保存的寄存器上下文和栈，直接操作用户空间栈，<strong>完全没有内核切换</strong>的开销。</li>
            </ul>
          </li>
          <li>动态协程栈
            <ul>
              <li>Goroutine 的栈只有 2KB大小，而且是动态伸缩的，可以按需调整大小，最大可达 1G。</li>
              <li>相比之下，线程也都有一个固定大小的内存块来做栈，一般会是 2MB 大小，线程栈会用来存储线程上下文信息。2MB 的线程栈和协程栈相比大了很多。</li>
            </ul>
          </li>
        </ul>
        <h2 id="goroutine"><a aria-hidden="true" tabindex="-1" href="#goroutine" class="anchor"><span class="icon icon-link"></span></a>Goroutine</h2>
        <h3 id="是什么有什么用"><a aria-hidden="true" tabindex="-1" href="#是什么有什么用" class="anchor"><span class="icon icon-link"></span></a>是什么，有什么用</h3>
        <ul>
          <li>
            <p>协程是<strong>轻量级的线程</strong>，与传统的进程和线程相比，协程的最大特点是 "轻"！可以轻松创建上百万个协程而不会导致系统资源衰竭。</p>
          </li>
          <li>
            <p>线程本身是有一定大小的，一般OS线程栈大小为**2MB，**且线程在创建和上下文切换的时候是需要消耗资源的，会带来性能损耗，所以在我们用到多线程技术的时候，我们往往会通过池化技术，即创建线程池来管理一定数量的线程。</p>
          </li>
          <li>
            <p>在go语言中，一个goroutine栈在其生命周期开始时占用空间很小（一般2KB），并且栈大小可以按需增大和缩小，goroutine的栈大小限制可以达到1GB，但是一般不会用到这么大。所以在Go语言中一次创建成千上万，甚至十万左右的goroutine理论上也是可以的。</p>
          </li>
        </ul>
        <h3 id="怎么用"><a aria-hidden="true" tabindex="-1" href="#怎么用" class="anchor"><span class="icon icon-link"></span></a>怎么用</h3>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code><input type="hidden" value="func()

go func()
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>将需要并发的任务封装成一个函数，然后再该函数前加上go关键字就行了，这样就开启了一个goroutine。</li>
        </ul>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">    <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="5">    <span class="token string">"sync"</span>
</span><span class="code-line line-number" line="6">    <span class="token string">"time"</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">func</span> <span class="token function">say</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"I am done ! id: "</span> <span class="token operator">+</span> id<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//wg中值 - 1</span>
</span><span class="code-line line-number" line="13"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// wait two groutines</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21">    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">       fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">       wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">    <span class="token keyword">go</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 等待所有任务完成，卡住如果wg不是0</span>
</span><span class="code-line line-number" line="29">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exit"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
    &#x22;fmt&#x22;
    &#x22;sync&#x22;
    &#x22;time&#x22;
)

func say(id string) {
    time.Sleep(time.Second)
    fmt.Println(&#x22;I am done ! id: &#x22; + id)
    wg.Done() //wg中值 - 1
}

var wg sync.WaitGroup

func main() {

    wg.Add(2) // wait two groutines

    go func(id string) {
       fmt.Println(id)
       wg.Done()
    }(&#x22;hello&#x22;)

    go say(&#x22;Hello&#x22;)

    wg.Wait() // 等待所有任务完成，卡住如果wg不是0
    fmt.Println(&#x22;exit&#x22;)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>定义一个WaitGroup， wg.Add告知要等待执行的任务，wg.Done在完成后减少计数，wg.Wait挂起</li>
          <li>匿名函数也可以使用Groutine</li>
        </ul>
        <h3 id="多协程异常捕获"><a aria-hidden="true" tabindex="-1" href="#多协程异常捕获" class="anchor"><span class="icon icon-link"></span></a>多协程异常捕获</h3>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">   <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="5">   <span class="token string">"time"</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="9">   <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">      <span class="token keyword">if</span> e <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="11">         fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"main recover:%v\n"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">      <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="13">   <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">   <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="16">      <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="17">         <span class="token keyword">if</span> e <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="18">            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"sub recover:%v\n"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">         <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="20">      <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">      <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"sub func panic!!!"</span><span class="token punctuation">)</span>  <span class="token comment">// 发生panic后，不会打印</span>
</span><span class="code-line line-number" line="22">      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"111"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">   <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25">   <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"main func panic!!!"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">   <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"main func panic!!!"</span><span class="token punctuation">)</span> <span class="token comment">// 一个recover，只能捕获一次pannic</span>
</span><span class="code-line line-number" line="27">   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"222"</span><span class="token punctuation">)</span>   <span class="token comment">// 发生panic后，不会打印</span>
</span><span class="code-line line-number" line="28">   time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
   &#x22;fmt&#x22;
   &#x22;time&#x22;
)

func main() {
   defer func() {
      if e := recover(); e != nil {
         fmt.Printf(&#x22;main recover:%v\n&#x22;, e)
      }
   }()

   go func() {
      defer func() {
         if e := recover(); e != nil {
            fmt.Printf(&#x22;sub recover:%v\n&#x22;, e)
         }
      }()
      panic(&#x22;sub func panic!!!&#x22;)  // 发生panic后，不会打印
      fmt.Println(&#x22;111&#x22;)
   }()

   panic(&#x22;main func panic!!!&#x22;)
   panic(&#x22;main func panic!!!&#x22;) // 一个recover，只能捕获一次pannic
   fmt.Println(&#x22;222&#x22;)   // 发生panic后，不会打印
   time.Sleep(2 * time.Second)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>用recover捕获异常时，只能捕获当前goroutine的panic，不能捕获其他goroutine发生的panic。</li>
          <li>main panic需要在main中设置对应的recover，goroutine中的panic也需要有对应的设置。</li>
        </ul>
        <h2 id="channel"><a aria-hidden="true" tabindex="-1" href="#channel" class="anchor"><span class="icon icon-link"></span></a>Channel</h2>
        <h3 id="是什么"><a aria-hidden="true" tabindex="-1" href="#是什么" class="anchor"><span class="icon icon-link"></span></a>是什么</h3>
        <ul>
          <li>Channel可以作为一个先入先出(FIFO)的队列，接收的数据和发送的数据的顺序是一致的。</li>
          <li>为了配合不同的Goroutine之间能够通信。</li>
          <li>可以把它看成一个可以收发数据的管道。</li>
        </ul>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">var</span> ch <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">type</span> RChannel<span class="token operator">=</span> <span class="token operator">&#x3C;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span>    <span class="token comment">// 定义单向读类型</span>
</span><span class="code-line line-number" line="3"><span class="token keyword">var</span> rec RChannel <span class="token operator">=</span> ch
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token keyword">type</span> SChannel <span class="token operator">=</span> <span class="token keyword">chan</span><span class="token operator">&#x3C;-</span> <span class="token builtin">int</span>  <span class="token comment">// 定义单向写类型</span>
</span><span class="code-line line-number" line="6"><span class="token keyword">var</span> send SChannel <span class="token operator">=</span> ch
</span></code><input type="hidden" value="var ch = make(chan int)
type RChannel= <-chan int    // 定义单向读类型
var rec RChannel = ch

type SChannel = chan<- int  // 定义单向写类型
var send SChannel = ch
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>Channel是可以定义方向的，单向接受或者发送数据，双向。</li>
        </ul>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">chan</span> T          <span class="token comment">// 可以接收和发送类型为 T 的数据</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">chan</span><span class="token operator">&#x3C;-</span> <span class="token builtin">float64</span>  <span class="token comment">// 只可以用来发送 float64 类型的数据</span>
</span><span class="code-line line-number" line="3"><span class="token operator">&#x3C;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span>      <span class="token comment">// 只可以用来接收 int 类型的数据</span>
</span></code><input type="hidden" value="chan T          // 可以接收和发送类型为 T 的数据
chan<- float64  // 只可以用来发送 float64 类型的数据
<-chan int      // 只可以用来接收 int 类型的数据
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>Channel可以分为有缓冲的和无缓冲的
            <ul>
              <li>无缓冲 channel 可以理解为同步模式，即写入一个，如果没有消费者在消费，写入就会阻塞。</li>
              <li>有缓冲 channel 可以理解为异步模式。即写入消息之后，即使还没被消费，只要队列没满，就可继续写入。</li>
              <li>如果有缓冲 channel 队列满了，那不就退化到同步了么？是的，如果队列满了，发送还是会阻塞。</li>
              <li>使用range遍历有缓存通道中值时，需要先<code>close(ch)</code>，否则会deadlock。</li>
            </ul>
          </li>
        </ul>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1">ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2">ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5"><span class="token keyword">for</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="6">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="ch := make(chan int)
ch := make(chan int, 100)

close(ch)
for val := range ch {
    fmt.Println(val)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>
            <p>如果channel c已经被关闭,继续往它发送数据会导致<code>panic: send on closed channel</code>:</p>
            <ul>
              <li>通常<code>x, ok := &#x3C;-ch</code>检查通道是否被关闭</li>
              <li>往nil channel中发送数据会一致被阻塞着</li>
              <li>从这个关闭的channel中不但可以读取出已发送的数据，还可以不断的读取nil。通过以下两种方式，只读取有效的值。</li>
            </ul>
            <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">      <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">         v<span class="token punctuation">,</span>ok <span class="token operator">:=</span> <span class="token operator">&#x3C;-</span>ch     <span class="token comment">// 判断句式读取</span>
</span><span class="code-line line-number" line="4">         <span class="token keyword">if</span> ok<span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"v=%d\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">         <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="7">            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"channel数据已读完\n"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">         <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="9">      <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="10"><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="15">   <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="16">   <span class="token string">"time"</span>
</span><span class="code-line line-number" line="17"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="20">   ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">   ch <span class="token operator">&#x3C;-</span> <span class="token number">1</span>
</span><span class="code-line line-number" line="22">   ch <span class="token operator">&#x3C;-</span> <span class="token number">2</span>
</span><span class="code-line line-number" line="23">   <span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">   <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="25">      <span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="26">         fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"v=%d\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">      <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="28">   <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">   time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="go func() {
      for i := 0; i < 5; i++ {
         v,ok := <-ch     // 判断句式读取
         if ok{
            fmt.Printf(&#x22;v=%d\n&#x22;, v)
         }else{
            fmt.Printf(&#x22;channel数据已读完\n&#x22;)
         }
      }
}()

package main

import (
   &#x22;fmt&#x22;
   &#x22;time&#x22;
)

func main() {
   ch := make(chan int, 5)
   ch <- 1
   ch <- 2
   close(ch)
   go func() {
      for v := range ch {
         fmt.Printf(&#x22;v=%d\n&#x22;, v)
      }
   }()
   time.Sleep(2 * time.Second)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
            <ul>
              <li>如果通过<code>range</code>读取，channel关闭后for循环会跳出，避免读取关闭后的零值。</li>
            </ul>
          </li>
          <li>
            <p>默认情况下，发送和接收会一直阻塞着，直到另一方准备好。这种方式可以用来在gororutine中进行同步，而不必使用显示的锁或者条件变量，channel是<strong>并发安全的</strong>。</p>
          </li>
        </ul>
        <h3 id="做什么"><a aria-hidden="true" tabindex="-1" href="#做什么" class="anchor"><span class="icon icon-link"></span></a>做什么</h3>
        <ul>
          <li>不以共享内存来通信，而以通信来共享内存</li>
          <li>协程之间可以利用Channel来传递数据</li>
        </ul>
        <h3 id="打个球"><a aria-hidden="true" tabindex="-1" href="#打个球" class="anchor"><span class="icon icon-link"></span></a>打个球</h3>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">    <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="5">    <span class="token string">"math/rand"</span>
</span><span class="code-line line-number" line="6">    <span class="token string">"sync"</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">func</span> <span class="token function">player</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">    <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12">    <span class="token keyword">for</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="13">       ball<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&#x3C;-</span>ch <span class="token comment">//怎么样从通道里拿值</span>
</span><span class="code-line line-number" line="14">       <span class="token comment">// 如果通道被关闭，err，如果为空没有值，会阻塞</span>
</span><span class="code-line line-number" line="15">       <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="16">          fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"channel is closed! %s wins\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">          <span class="token keyword">return</span>
</span><span class="code-line line-number" line="18">       <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">       n <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">       <span class="token keyword">if</span> n<span class="token operator">%</span><span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">          <span class="token comment">// 把球打飞</span>
</span><span class="code-line line-number" line="23">          <span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">          fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s misses the ball ! %s loses\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">          <span class="token keyword">return</span>
</span><span class="code-line line-number" line="26">       <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="27">       ball<span class="token operator">++</span>
</span><span class="code-line line-number" line="28">       fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s receives ball %d\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> ball<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">       ch <span class="token operator">&#x3C;-</span> ball
</span><span class="code-line line-number" line="30">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="31"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="32">
</span><span class="code-line line-number" line="33"><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
</span><span class="code-line line-number" line="34">
</span><span class="code-line line-number" line="35"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="36">
</span><span class="code-line line-number" line="37">    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// wait two groutines</span>
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39">    ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="40">
</span><span class="code-line line-number" line="41">    <span class="token comment">//ch &#x3C;- 0 //error</span>
</span><span class="code-line line-number" line="42">    
</span><span class="code-line line-number" line="43">    <span class="token keyword">go</span> <span class="token function">player</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="44">    <span class="token keyword">go</span> <span class="token function">player</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="45">
</span><span class="code-line line-number" line="46">    ch <span class="token operator">&#x3C;-</span> <span class="token number">0</span>
</span><span class="code-line line-number" line="47">    <span class="token comment">// 先生成goroutine，再传球</span>
</span><span class="code-line line-number" line="48">    <span class="token comment">// 必须保证channel有人接受（传球）</span>
</span><span class="code-line line-number" line="49">
</span><span class="code-line line-number" line="50">    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 等待所有任务完成，卡住如果wg不是0</span>
</span><span class="code-line line-number" line="51">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exit"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="52"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
    &#x22;fmt&#x22;
    &#x22;math/rand&#x22;
    &#x22;sync&#x22;
)

func player(name string, ch chan int) {
    defer wg.Done()

    for {
       ball, ok := <-ch //怎么样从通道里拿值
       // 如果通道被关闭，err，如果为空没有值，会阻塞
       if !ok {
          fmt.Printf(&#x22;channel is closed! %s wins\n&#x22;, name)
          return
       }

       n := rand.Intn(100)
       if n%10 == 0 {
          // 把球打飞
          close(ch)
          fmt.Printf(&#x22;%s misses the ball ! %s loses\n&#x22;, name, name)
          return
       }
       ball++
       fmt.Printf(&#x22;%s receives ball %d\n&#x22;, name, ball)
       ch <- ball
    }
}

var wg sync.WaitGroup

func main() {

    wg.Add(2) // wait two groutines

    ch := make(chan int, 0)

    //ch <- 0 //error
    
    go player(&#x22;A&#x22;, ch)
    go player(&#x22;B&#x22;, ch)

    ch <- 0
    // 先生成goroutine，再传球
    // 必须保证channel有人接受（传球）

    wg.Wait() // 等待所有任务完成，卡住如果wg不是0
    fmt.Println(&#x22;exit&#x22;)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h2 id="context"><a aria-hidden="true" tabindex="-1" href="#context" class="anchor"><span class="icon icon-link"></span></a>Context</h2>
        <h3 id="是什么用来做什么"><a aria-hidden="true" tabindex="-1" href="#是什么用来做什么" class="anchor"><span class="icon icon-link"></span></a>是什么，用来做什么</h3>
        <ul>
          <li>context 主要用来在 goroutine 之间传递上下文信息，包括：取消信号、超时时间、截止时间、k-v 等。
            <ul>
              <li>一个请求在多个协程中运行时，当其中一个出现错误，剩下的运行没有了意义，可以通过context通知子goroutine优雅关闭</li>
            </ul>
          </li>
          <li>在Go里不能Go里不能杀死协程，协程的关闭一般会用 <code>channel+select</code> 方式来控制。
            <ul>
              <li>在某些场景下，例如处理一个请求衍生了很多协程，这些协程之间是相互关联的：需要共享一些全局变量、有共同的 deadline 等，而且可以同时被关闭。再用 <code>channel+select</code> 就会比较麻烦，这时就可以通过 context 来实现。</li>
            </ul>
          </li>
        </ul>
        <h3 id="接口"><a aria-hidden="true" tabindex="-1" href="#接口" class="anchor"><span class="icon icon-link"></span></a>接口</h3>
        <h4 id="context-1"><a aria-hidden="true" tabindex="-1" href="#context-1" class="anchor"><span class="icon icon-link"></span></a>context</h4>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">    <span class="token comment">// 当 context 被取消或者到了 deadline，返回一个被关闭的 channel</span>
</span><span class="code-line line-number" line="3">    <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">    <span class="token comment">// 在 channel Done 关闭后，返回 context 取消原因</span>
</span><span class="code-line line-number" line="6">    <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">    <span class="token comment">// 返回 context 是否会被取消以及自动取消时间（即 deadline）</span>
</span><span class="code-line line-number" line="9">    <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">    <span class="token comment">// 获取 key 对应的 value</span>
</span><span class="code-line line-number" line="12">    <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="13"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="type Context interface {
    // 当 context 被取消或者到了 deadline，返回一个被关闭的 channel
    Done() <-chan struct{}

    // 在 channel Done 关闭后，返回 context 取消原因
    Err() error

    // 返回 context 是否会被取消以及自动取消时间（即 deadline）
    Deadline() (deadline time.Time, ok bool)

    // 获取 key 对应的 value
    Value(key interface{}) interface{}
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>
            <p><code>Context</code> 是一个接口，定义了 4 个方法，它们都是<code>幂等</code>的。也就是说连续多次调用同一个方法，得到的结果都是相同的。</p>
          </li>
          <li>
            <p><code>Done() &#x3C;-chan struct{}</code>这里返回是一个只读的Channel，对于没有传递值的Channel，读不出任何的值，当Channel关闭时，可以读取对应类型的nil值，作为channel关闭的信号，表明要尽快做退出处理。</p>
          </li>
          <li>
            <p><code>Err()</code> 返回一个错误，表示 channel 被关闭的原因。例如是被取消，还是超时。</p>
            <ul>
              <li>只会在 Done 返回的 Channel 被关闭时才会返回非空的值，返回值有以下两种情况；
                <ul>
                  <li>如果 是context.Context 被取消，返回 Canceled</li>
                  <li>如果 是context.Context 超时，返回 DeadlineExceeded</li>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            <p><code>Deadline()</code> 返回 context 的截止时间，通过此时间，函数就可以决定是否进行接下来的操作，如果时间太短，就可以不往下做了，否则浪费系统资源。当然，也可以用这个 deadline 来设置一个 I/O 操作的超时时间。</p>
          </li>
          <li>
            <p><code>Value()</code> 获取之前设置的 key 对应的 value。</p>
          </li>
        </ul>
        <h4 id="canceler"><a aria-hidden="true" tabindex="-1" href="#canceler" class="anchor"><span class="icon icon-link"></span></a>canceler</h4>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">type</span> canceler <span class="token keyword">interface</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">    <span class="token function">cancel</span><span class="token punctuation">(</span>removeFromParent <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">    <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="4"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="type canceler interface {
    cancel(removeFromParent bool, err error)
    Done() <-chan struct{}
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>实现上面定义的两个方法的Context，表明该Context是可以取消的</li>
          <li>为什么这样设计
            <ul>
              <li>“取消”操作应该是建议性，而非强制性。只有实现了这个接口，Context才会是可取消的。caller 不应该去关心、干涉 callee 的情况，决定如何以及何时 return 是 callee 的责任。caller 只需发送“取消”信息，callee 根据收到的信息来做进一步的决策，因此接口并没有定义 cancel 方法。</li>
              <li>“取消”操作应该可传递。“取消”某个函数时，和它相关联的其他函数也应该“取消”。因此，<code>Done()</code> 方法返回一个只读的 channel，所有相关函数监听此 channel。一旦 channel 关闭，通过 channel 的“广播机制”，所有监听者都能收到。</li>
            </ul>
          </li>
        </ul>
        <h4 id="emptyctx"><a aria-hidden="true" tabindex="-1" href="#emptyctx" class="anchor"><span class="icon icon-link"></span></a>emptyCtx</h4>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">type</span> emptyCtx <span class="token builtin">int</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="4">    <span class="token keyword">return</span>
</span><span class="code-line line-number" line="5"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="8">    <span class="token keyword">return</span> <span class="token boolean">nil</span>
</span><span class="code-line line-number" line="9"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">    <span class="token keyword">return</span> <span class="token boolean">nil</span>
</span><span class="code-line line-number" line="13"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="16">    <span class="token keyword">return</span> <span class="token boolean">nil</span>
</span><span class="code-line line-number" line="17"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="type emptyCtx int

func (*emptyCtx) Deadline() (deadline time.Time, ok bool) {
    return
}

func (*emptyCtx) Done() <-chan struct{} {
    return nil
}

func (*emptyCtx) Err() error {
    return nil
}

func (*emptyCtx) Value(key interface{}) interface{} {
    return nil
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>这是一个空的 context，永远不会被 cancel，没有存储值，也没有 deadline。</li>
        </ul>
        <p>通常被包装后，通过两个导出函数导出</p>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">var</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    background <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>emptyCtx<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">    todo       <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>emptyCtx<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment">// 注意首字母大写</span>
</span><span class="code-line line-number" line="7"><span class="token keyword">func</span> <span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Context <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="8">    <span class="token keyword">return</span> background
</span><span class="code-line line-number" line="9"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token keyword">func</span> <span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Context <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">    <span class="token keyword">return</span> todo
</span><span class="code-line line-number" line="13"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="var (
    background = new(emptyCtx)
    todo       = new(emptyCtx)
)

// 注意首字母大写
func Background() Context {
    return background
}

func TODO() Context {
    return todo
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>background 通常用在 main 函数中，作为所有 context 的根节点。</li>
          <li>todo 通常用在并不知道传递什么 context的情形。例如，调用一个需要传递 context 参数的函数，你手头并没有其他 context 可以传递，这时就可以传递 todo。这常常发生在重构进行中，给一些函数添加了一个 Context 参数，但不知道要传什么，就用 todo “占个位子”，最终要换成其他 context。</li>
        </ul>
        <h4 id="cancelctx"><a aria-hidden="true" tabindex="-1" href="#cancelctx" class="anchor"><span class="icon icon-link"></span></a>cancelCtx</h4>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">type</span> cancelCtx <span class="token keyword">struct</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">    Context
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token comment">// 保护之后的字段</span>
</span><span class="code-line line-number" line="5">    mu       sync<span class="token punctuation">.</span>Mutex
</span><span class="code-line line-number" line="6">    done     <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="7">    children <span class="token keyword">map</span><span class="token punctuation">[</span>canceler<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="8">    err      <span class="token builtin">error</span>
</span><span class="code-line line-number" line="9"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="type cancelCtx struct {
    Context

    // 保护之后的字段
    mu       sync.Mutex
    done     chan struct{}
    children map[canceler]struct{}
    err      error
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <p>一个可以取消的 Context，实现了 canceler 接口。它直接将接口 Context 作为它的一个匿名字段，这样，它就可以被看成一个 Context。</p>
        <h3 id="如何使用"><a aria-hidden="true" tabindex="-1" href="#如何使用" class="anchor"><span class="icon icon-link"></span></a>如何使用</h3>
        <ul>
          <li>
            <p>源码里对外提供了一个创建根节点 context 的函数</p>
            <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1">ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2">ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code><input type="hidden" value="ctx := context.Background()
ctx := context.TODO()
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
            <ul>
              <li>background 是一个空的 context， 它不能被取消，没有值，也没有超时时间。可以用在main函数或者顶级请求中来派生其他context</li>
              <li>使用TODO函数获得一个空context，只能用于高等级或者不确定使用什么context类型。</li>
            </ul>
          </li>
          <li>
            <p>有了根节点 context，又提供了四个函数创建子节点 context：</p>
            <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">func</span> <span class="token function">WithCancel</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctx Context<span class="token punctuation">,</span> cancel CancelFunc<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">func</span> <span class="token function">WithDeadline</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3"><span class="token keyword">func</span> <span class="token function">WithTimeout</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4"><span class="token keyword">func</span> <span class="token function">WithValue</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> Context
</span></code><input type="hidden" value="func WithCancel(parent Context) (ctx Context, cancel CancelFunc)
func WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc)
func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)
func WithValue(parent Context, key, val interface{}) Context
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
            <ul>
              <li>context 会在函数传递间传递。只需要在适当的时间调用 cancel 函数向 goroutines 发出取消信号或者调用 Value 函数取出 context 中的值。</li>
              <li>基于当前context，每个with函数都会创建出一个新的context，这样类似于我们熟悉的树结构，当前context称为父context，派生出的新context称为子context。就像下面的context树结构：</li>
            </ul>
            <p>
              <img src="D:/DownLoadForAll/1280X1280.PNG" alt="1280X1280">
            </p>
            <ul>
              <li>通过根context，通过四个with系列方法可以派生出四种类型的context，每种context又可以通过同样的方式调用with系列方法继续向下派生新的context，整个结构像一棵树。</li>
            </ul>
          </li>
          <li>
            <p>使用建议</p>
            <ul>
              <li>不要将 Context 塞到结构体里。直接将 Context 类型作为函数的第一参数，而且一般都命名为 ctx。</li>
              <li>不要向函数传入一个 nil 的 context，如果你实在不知道传什么，标准库给你准备好了一个 context：todo。</li>
              <li>不要把本应该作为函数参数的类型塞到 context 中，context 存储的应该是一些共同的数据。例如：登陆的 session、cookie 等。</li>
              <li>同一个 context 可能会被传递到多个 goroutine，别担心，context 是并发安全的。</li>
            </ul>
          </li>
        </ul>
        <h4 id="contextwithcancel"><a aria-hidden="true" tabindex="-1" href="#contextwithcancel" class="anchor"><span class="icon icon-link"></span></a>context.WithCancel</h4>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">   <span class="token string">"context"</span>
</span><span class="code-line line-number" line="5">   <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="6">   <span class="token string">"time"</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">   ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">   <span class="token keyword">go</span> <span class="token function">Watch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"goroutine1"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">   <span class="token keyword">go</span> <span class="token function">Watch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"goroutine2"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">   time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>   <span class="token comment">// 让goroutine1和goroutine2执行6s</span>
</span><span class="code-line line-number" line="15">   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"end watching!!!"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">   <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 通知goroutine1和goroutine2关闭</span>
</span><span class="code-line line-number" line="17">   time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20"><span class="token keyword">func</span> <span class="token function">Watch</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="21">   <span class="token keyword">for</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">      <span class="token keyword">select</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="23">      <span class="token keyword">case</span> <span class="token operator">&#x3C;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="24">         fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s exit!\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token comment">// 主goroutine调用cancel后，会发送一个信号到ctx.Done()这个channel，这里就会收到信息</span>
</span><span class="code-line line-number" line="25">         <span class="token keyword">return</span>
</span><span class="code-line line-number" line="26">      <span class="token keyword">default</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="27">         fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s watching...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">         time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">      <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="30">   <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="31"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
   &#x22;context&#x22;
   &#x22;fmt&#x22;
   &#x22;time&#x22;
)

func main() {
   ctx, cancel := context.WithCancel(context.Background())
   go Watch(ctx, &#x22;goroutine1&#x22;)
   go Watch(ctx, &#x22;goroutine2&#x22;)

   time.Sleep(6 * time.Second)   // 让goroutine1和goroutine2执行6s
   fmt.Println(&#x22;end watching!!!&#x22;)
   cancel()  // 通知goroutine1和goroutine2关闭
   time.Sleep(1 * time.Second)
}

func Watch(ctx context.Context, name string) {
   for {
      select {
      case <-ctx.Done():
         fmt.Printf(&#x22;%s exit!\n&#x22;, name) // 主goroutine调用cancel后，会发送一个信号到ctx.Done()这个channel，这里就会收到信息
         return
      default:
         fmt.Printf(&#x22;%s watching...\n&#x22;, name)
         time.Sleep(time.Second)
      }
   }
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>context.WithCancel是一个取消控制函数。</li>
          <li>ctx, cancel := context.WithCancel(context.Background())派生出了一个带有返回函数cancel的ctx</li>
          <li>将之传到goroutine当中，当执行cancel函数时，此时子goroutine会从ctx.Done()这个channel中收到消息，执行return结束。</li>
        </ul>
        <h4 id="contextwithdeadline"><a aria-hidden="true" tabindex="-1" href="#contextwithdeadline" class="anchor"><span class="icon icon-link"></span></a>context.WithDeadline</h4>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">   <span class="token string">"context"</span>
</span><span class="code-line line-number" line="5">   <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="6">   <span class="token string">"time"</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">   ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithDeadline</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 设置超时时间4当前时间4s之后</span>
</span><span class="code-line line-number" line="11">   <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">   <span class="token keyword">go</span> <span class="token function">Watch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"goroutine1"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">   <span class="token keyword">go</span> <span class="token function">Watch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"goroutine2"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">   time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>   <span class="token comment">// 让goroutine1和goroutine2执行6s</span>
</span><span class="code-line line-number" line="16">   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"end watching!!!"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19"><span class="token keyword">func</span> <span class="token function">Watch</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="20">   <span class="token keyword">for</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="21">      <span class="token keyword">select</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">      <span class="token keyword">case</span> <span class="token operator">&#x3C;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="23">         fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s exit!\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token comment">// 4s之后收到信号</span>
</span><span class="code-line line-number" line="24">         <span class="token keyword">return</span>
</span><span class="code-line line-number" line="25">      <span class="token keyword">default</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="26">         fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s watching...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">         time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">      <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="29">   <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="30"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
   &#x22;context&#x22;
   &#x22;fmt&#x22;
   &#x22;time&#x22;
)

func main() {
   ctx, cancel := context.WithDeadline(context.Background(),time.Now().Add(4*time.Second)) // 设置超时时间4当前时间4s之后
   defer cancel()
   go Watch(ctx, &#x22;goroutine1&#x22;)
   go Watch(ctx, &#x22;goroutine2&#x22;)

   time.Sleep(6 * time.Second)   // 让goroutine1和goroutine2执行6s
   fmt.Println(&#x22;end watching!!!&#x22;)
}

func Watch(ctx context.Context, name string) {
   for {
      select {
      case <-ctx.Done():
         fmt.Printf(&#x22;%s exit!\n&#x22;, name) // 4s之后收到信号
         return
      default:
         fmt.Printf(&#x22;%s watching...\n&#x22;, name)
         time.Sleep(time.Second)
      }
   }
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>context.WithDeadline也是一个取消控制函数</li>
          <li>返回值包括一个context和一个取消函数CancelFunc。
            <ul>
              <li>在使用的时候，没有到截止时间，我们可以通过手动调用CancelFunc来取消子context，控制子goroutine的退出</li>
              <li>如果到了截止时间，我们都没有调用CancelFunc，子context的Done()管道也会收到一个取消信号，用来控制子goroutine退出。</li>
            </ul>
          </li>
        </ul>
        <h4 id="contextwithtimeout"><a aria-hidden="true" tabindex="-1" href="#contextwithtimeout" class="anchor"><span class="icon icon-link"></span></a>context.WithTimeout</h4>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">   <span class="token string">"context"</span>
</span><span class="code-line line-number" line="5">   <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="6">   <span class="token string">"time"</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">   ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">   <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">   <span class="token keyword">go</span> <span class="token function">Watch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"goroutine1"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">   <span class="token keyword">go</span> <span class="token function">Watch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"goroutine2"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">   time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>   <span class="token comment">// 让goroutine1和goroutine2执行6s</span>
</span><span class="code-line line-number" line="16">   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"end watching!!!"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19"><span class="token keyword">func</span> <span class="token function">Watch</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="20">   <span class="token keyword">for</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="21">      <span class="token keyword">select</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">      <span class="token keyword">case</span> <span class="token operator">&#x3C;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="23">         fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s exit!\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token comment">// 主goroutine调用cancel后，会发送一个信号到ctx.Done()这个channel，这里就会收到信息</span>
</span><span class="code-line line-number" line="24">         <span class="token keyword">return</span>
</span><span class="code-line line-number" line="25">      <span class="token keyword">default</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="26">         fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s watching...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">         time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">      <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="29">   <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="30"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
   &#x22;context&#x22;
   &#x22;fmt&#x22;
   &#x22;time&#x22;
)

func main() {
   ctx, cancel := context.WithTimeout(context.Background(), 4*time.Second)
   defer cancel()
   go Watch(ctx, &#x22;goroutine1&#x22;)
   go Watch(ctx, &#x22;goroutine2&#x22;)

   time.Sleep(6 * time.Second)   // 让goroutine1和goroutine2执行6s
   fmt.Println(&#x22;end watching!!!&#x22;)
}

func Watch(ctx context.Context, name string) {
   for {
      select {
      case <-ctx.Done():
         fmt.Printf(&#x22;%s exit!\n&#x22;, name) // 主goroutine调用cancel后，会发送一个信号到ctx.Done()这个channel，这里就会收到信息
         return
      default:
         fmt.Printf(&#x22;%s watching...\n&#x22;, name)
         time.Sleep(time.Second)
      }
   }
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>context.WithTimeout和context.WithDeadline的作用类似，都是用于超时取消子context，只是传递的第二个参数有所不同，context.WithTimeout传递的第二个参数不是具体时间，而是时间长度。</li>
        </ul>
        <h4 id="contextwithvalue"><a aria-hidden="true" tabindex="-1" href="#contextwithvalue" class="anchor"><span class="icon icon-link"></span></a>context.WithValue</h4>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">   <span class="token string">"context"</span>
</span><span class="code-line line-number" line="5">   <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="6">   <span class="token string">"time"</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">func</span> <span class="token function">func1</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">   fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"name is: %s"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="14">   ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"zhangsan"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">   <span class="token keyword">go</span> <span class="token function">func1</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">   time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
   &#x22;context&#x22;
   &#x22;fmt&#x22;
   &#x22;time&#x22;
)

func func1(ctx context.Context) {
   fmt.Printf(&#x22;name is: %s&#x22;, ctx.Value(&#x22;name&#x22;).(string))
}

func main() {
   ctx := context.WithValue(context.Background(), &#x22;name&#x22;, &#x22;zhangsan&#x22;)
   go func1(ctx)
   time.Sleep(time.Second)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>context.WithValu 函数从父context中创建一个子context用于传值，函数参数是父context，key，val键值对。返回一个context。</li>
          <li>项目中这个方法一般用于上下文信息的传递，比如请求唯一id，以及trace_id等，用于链路追踪以及配置透传。</li>
        </ul>
        <h4 id="示例1"><a aria-hidden="true" tabindex="-1" href="#示例1" class="anchor"><span class="icon icon-link"></span></a>示例1</h4>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">	<span class="token string">"context"</span>
</span><span class="code-line line-number" line="5">	<span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="6">	<span class="token string">"time"</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">func</span> <span class="token function">doSomething</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">	<span class="token keyword">select</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="11">	<span class="token keyword">case</span> <span class="token operator">&#x3C;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="12">		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"finish doing something"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">	<span class="token keyword">case</span> <span class="token operator">&#x3C;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="14">		err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="16">			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">		<span class="token punctuation">}</span>
</span><span class="code-line line-number" line="18">	<span class="token punctuation">}</span>
</span><span class="code-line line-number" line="19"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// root context, return nil context</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">	<span class="token comment">//todoCtx := context.TODO() // 不确定context类型时使用</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="29">		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30">		<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="31">	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">	<span class="token function">doSomething</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
	&#x22;context&#x22;
	&#x22;fmt&#x22;
	&#x22;time&#x22;
)

func doSomething(ctx context.Context) {
	select {
	case <-time.After(5 * time.Second):
		fmt.Println(&#x22;finish doing something&#x22;)
	case <-ctx.Done():
		err := ctx.Err()
		if err != nil {
			fmt.Println(err.Error())
		}
	}
}

func main() {
	ctx := context.Background() // root context, return nil context

	//todoCtx := context.TODO() // 不确定context类型时使用

	ctx, cancel := context.WithCancel(ctx)

	go func() {
		time.Sleep(6 * time.Second)
		cancel()
	}()
	doSomething(ctx)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h2 id="sync"><a aria-hidden="true" tabindex="-1" href="#sync" class="anchor"><span class="icon icon-link"></span></a>Sync</h2>
        <p>Goroutine之间可以通过channel来写作，同样也能像传统的对共享内存并发安全</p>
        <ul>
          <li>
            <p>最基础的，是通过<code>time.Sleep</code>方法，让主goroutine等待一段时间，以便子goroutine能够执行完，显然这个办法不好，不能确定子goroutine需要的时间。</p>
          </li>
          <li>
            <p>使用<code>channel</code>，主goroutine向子goroutine里发送<code>struct{}</code>，直到数据全部取出完毕才能继续后面的逻辑，这样就可以实现等待各个goroutine执行完。显然不是好的办法，管道需要内存开销，并且需要确定执行的次数。</p>
          </li>
        </ul>
        <h3 id="waitgroup"><a aria-hidden="true" tabindex="-1" href="#waitgroup" class="anchor"><span class="icon icon-link"></span></a>waitGroup</h3>
        <ul>
          <li><code>sync.WaitGroup</code>，使用sync包下的waitgroup来实现并发任务的同步和协程任务。
            <ul>
              <li>sync.WaitGroup是一个对象，里面维护着一个计数器，通过add，done，wait完成对计数加减，代码的阻塞。</li>
            </ul>
          </li>
        </ul>
        <h3 id="synconce"><a aria-hidden="true" tabindex="-1" href="#synconce" class="anchor"><span class="icon icon-link"></span></a>sync.Once</h3>
        <ul>
          <li><code>sync.Once</code>，并不会在程序启动的时候初始化，而是在第一次用的它的时候才会初始化，并且只初始化这一次，初始化之后驻留在内存里，这就非常适合我们之前提到的配置文件加载场景。
            <ul>
              <li>只有在第一次调用<code>InitConfig()</code>获取Config 指针的时候才会执行<code>once.Do(func(){instance = &#x26;Config{} })</code>语句，执行完之后instance就驻留在内存中，后面再次执行InitConfig()的时候，就直接返回内存中的instance。</li>
              <li>Init()是所在package首次加载时执行，而sync.Onece可以在代码的任意位置初始化和调用，是在第一次用的它的时候才会初始化。</li>
            </ul>
          </li>
        </ul>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token comment">// 声明配置结构体Config</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">type</span> Config <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">var</span> instance Config
</span><span class="code-line line-number" line="5"><span class="token keyword">var</span> once sync<span class="token punctuation">.</span>Once     <span class="token comment">// 声明一个sync.Once变量</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment">// 获取配置结构体</span>
</span><span class="code-line line-number" line="8"><span class="token keyword">func</span> <span class="token function">InitConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Config <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="9">   once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">      instance <span class="token operator">=</span> <span class="token operator">&#x26;</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="11">   <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">   <span class="token keyword">return</span> instance
</span><span class="code-line line-number" line="13"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="// 声明配置结构体Config
type Config struct{}

var instance Config
var once sync.Once     // 声明一个sync.Once变量

// 获取配置结构体
func InitConfig() *Config {
   once.Do(func(){
      instance = &#x26;Config{}
   })
   return instance
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h3 id="synclock"><a aria-hidden="true" tabindex="-1" href="#synclock" class="anchor"><span class="icon icon-link"></span></a>sync.Lock</h3>
        <ul>
          <li>使用<strong>互斥锁</strong>：用来解决多个goroutine对同一资源争抢问题</li>
        </ul>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">var</span> mtx sync<span class="token punctuation">.</span>Mutex
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3">mtx<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">mtx<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code><input type="hidden" value="var mtx sync.Mutex

mtx.Lock()
mtx.Unlock()
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>使用WaitGroup等待所有协程执行结束，再使用互斥锁来保证并发安全，配合<code>defer mtx.Unlock()</code>。</li>
        </ul>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">// 对写锁加锁</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// 对写锁解锁</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 对读锁加锁</span>
</span><span class="code-line line-number" line="5"><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 对读锁解锁</span>
</span></code><input type="hidden" value="func (rw *RWMutex) Lock()     // 对写锁加锁
func (rw *RWMutex) Unlock()   // 对写锁解锁

func (rw *RWMutex) RLock()    // 对读锁加锁
func (rw *RWMutex) RUnlock()  // 对读锁解锁
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <p><strong>读写锁</strong>的使用遵循以下几个法则：</p>
        <ol>
          <li>同时只能有一个 goroutine 能够获得写锁定。</li>
          <li>同时可以有任意多个 gorouinte 获得读锁定。</li>
          <li>同时只能存在写锁定或读锁定（读和写互斥）。</li>
        </ol>
        <p>通俗理解就是可以多个goroutine同时读，但是只有一个goroutine能写，共享资源要么在被一个或多个goroutine读取，要么在被一个goroutine写入， 读写不能同时进行。</p>
        <blockquote>
          <p>当有读锁，写的时候会阻塞。读写之间互斥。</p>
        </blockquote>
        <h3 id="死锁"><a aria-hidden="true" tabindex="-1" href="#死锁" class="anchor"><span class="icon icon-link"></span></a>死锁</h3>
        <ul>
          <li>如果将带有锁结构的变量赋值给其他变量，<strong>锁的状态会复制</strong>。对已经是加锁状态的变量再加锁，没有办法等到前一个解锁机会，从而导致死锁。
            <ul>
              <li>在使用锁的时候，我们应当尽量避免锁拷贝，并且保证Lock()和Unlock()成对出现，没有成对出现容易会出现死锁的情况，或者是Unlock 一个未加锁的Mutex而导致 panic。</li>
            </ul>
          </li>
          <li>循环等待：容易造成死锁的场景就是循环等待，A等B，B等C，C等A，循环等待。</li>
        </ul>
        <h3 id="syncmap"><a aria-hidden="true" tabindex="-1" href="#syncmap" class="anchor"><span class="icon icon-link"></span></a>sync.Map</h3>
        <p>go语言内置的Map并不是线程安全的，在多个goroutine同时操作map的时候，会有并发问题。</p>
        <ul>
          <li>整个操作过程中进行加锁和解锁处理。</li>
          <li>用sync包中提供的一个开箱即用的并发安全版map–sync.Map,在 Go 1.9 引入。</li>
        </ul>
        <h3 id="syncatomic"><a aria-hidden="true" tabindex="-1" href="#syncatomic" class="anchor"><span class="icon icon-link"></span></a>sync.Atomic</h3>
        <p>原子操作就是这一系列的操作在cpu上执行是一个不可分割的整体，显然要么全部执行，要么全部不执行，不会受到其他操作的影响，也就不会存在并发问题。</p>
        <ul>
          <li>atomic是对变量进行操作，而mutex是对代码段进行保护。</li>
        </ul>
        <h2 id="select"><a aria-hidden="true" tabindex="-1" href="#select" class="anchor"><span class="icon icon-link"></span></a>Select</h2>
        <p>Go语言的select语句，是用来起一个goroutine监听多个Channel的读写事件，提高从多个Channel获取信息的效率，相当于也是单线程处理多个IO事件，其思想基本相同。</p>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">select</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">        <span class="token keyword">case</span> <span class="token operator">&#x3C;-</span> channel1<span class="token punctuation">:</span>     <span class="token comment">// 如果从channel1读取数据成功，执行case语句 </span>
</span><span class="code-line line-number" line="3">          do <span class="token operator">...</span>   
</span><span class="code-line line-number" line="4">        <span class="token keyword">case</span> channel2 <span class="token operator">&#x3C;-</span> <span class="token number">1</span><span class="token punctuation">:</span>   <span class="token comment">// 如果向channel2写入数据成功，执行case语句 </span>
</span><span class="code-line line-number" line="5">          do <span class="token operator">...</span>          
</span><span class="code-line line-number" line="6">        <span class="token keyword">default</span><span class="token punctuation">:</span>              <span class="token comment">// 如果上面都没有成功，进入default处理流程</span>
</span><span class="code-line line-number" line="7">          do <span class="token operator">...</span>
</span><span class="code-line line-number" line="8"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="select {
        case <- channel1:     // 如果从channel1读取数据成功，执行case语句 
          do ...   
        case channel2 <- 1:   // 如果向channel2写入数据成功，执行case语句 
          do ...          
        default:              // 如果上面都没有成功，进入default处理流程
          do ...
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>select各个case的表达式必须都是channel的读写操作</li>
          <li>如果没有可以执行的case，则执行default语句，如果没有default，则当前goroutine会阻塞。</li>
          <li>没有default且case无法执行的select永久阻塞</li>
          <li>当多个case都准备好了的时候，会随机选择一个执行</li>
        </ul>
        <h2 id="timer"><a aria-hidden="true" tabindex="-1" href="#timer" class="anchor"><span class="icon icon-link"></span></a>Timer</h2>
        <p>Time是一种一次性时间定时器，即在未来某个时刻，触发的事件只会执行一次。</p>
        <h3 id="创建timer"><a aria-hidden="true" tabindex="-1" href="#创建timer" class="anchor"><span class="icon icon-link"></span></a>创建Timer</h3>
        <p>Timer结构里有一个Time类型的管道C，主要用于事件通知。在未到达设定时间的时候，管道内没有数据写入，一直处于阻塞状态，到达设定时间后，会向管道内写入一个系统事时间，触发事件。</p>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">   <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="5">   <span class="token string">"time"</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="9">   timer <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">//设置超时时间2s</span>
</span><span class="code-line line-number" line="10">   <span class="token operator">&#x3C;-</span>timer<span class="token punctuation">.</span>C
</span><span class="code-line line-number" line="11">   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"after 2s Time out!"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
   &#x22;fmt&#x22;
   &#x22;time&#x22;
)

func main() {
   timer := time.NewTimer(2 * time.Second) //设置超时时间2s
   <-timer.C
   fmt.Println(&#x22;after 2s Time out!&#x22;)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>创建一个定时器timer，设置超时时间2s，执行&#x3C;-timer.C会一直阻塞，知道2s后，程序继续执行。</li>
        </ul>
        <h3 id="停止timer"><a aria-hidden="true" tabindex="-1" href="#停止timer" class="anchor"><span class="icon icon-link"></span></a>停止Timer</h3>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">   <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="5">   <span class="token string">"time"</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="9">    timer <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">//设置超时时间2s</span>
</span><span class="code-line line-number" line="10">    res <span class="token operator">:=</span> timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
   &#x22;fmt&#x22;
   &#x22;time&#x22;
)

func main()  {
    timer := time.NewTimer(2 * time.Second) //设置超时时间2s
    res := timer.Stop()
    fmt.Printf(res)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <p>返回值：</p>
        <ul>
          <li>true：执行stop()时timer还没有到达超时时间，即超时时间内停止了timer。</li>
          <li>false：执行stop()时timer到达了超时时间，过了超时时间才停止timer。</li>
        </ul>
        <h3 id="重置timer"><a aria-hidden="true" tabindex="-1" href="#重置timer" class="anchor"><span class="icon icon-link"></span></a>重置Timer</h3>
        <p>对于已经过期或者是已经停止的timer，可以通过重置方法激活使其继续生效。</p>
        <h3 id="timeafterfunc"><a aria-hidden="true" tabindex="-1" href="#timeafterfunc" class="anchor"><span class="icon icon-link"></span></a>time.AfterFunc</h3>
        <p>time.AfterFunc参数为超时时间d和一个具体的函数f，返回一个Timer的指针，作用在创建出timer之后，在当前goroutine，等待一段时间d之后，将执行f。</p>
        <h3 id="timeafter"><a aria-hidden="true" tabindex="-1" href="#timeafter" class="anchor"><span class="icon icon-link"></span></a>time.After</h3>
        <p>根据函数定义可以看到，after函数经过时间短d之后会返回timer里的管道，并且这个管道会在经过时段d之后写入数据，调用这个函数，就相当于实现了定时器。</p>
        <h3 id="ticker"><a aria-hidden="true" tabindex="-1" href="#ticker" class="anchor"><span class="icon icon-link"></span></a>Ticker</h3>
        <p>对比timer，Ticker对象会每隔一段时间d就向该通道发送当时的时间，根据这个管道消息来触发事件，但是从定义完成，就会每隔一段时间触发，只有关闭Ticker对象才不会继续发送时间消息。</p>
        <h2 id="协程池"><a aria-hidden="true" tabindex="-1" href="#协程池" class="anchor"><span class="icon icon-link"></span></a>协程池</h2>
        <p>go语言虽然有着高效的GMP调度模型，理论上支持成千上万的goroutine，但是goroutine过多，对调度，gc以及系统内存都会造成压力，这样会使我们的服务性能不升反降。常用做法可以用池化技术，构造一个协程池，把进程中的协程控制在一定的数量，防止系统中goroutine过多，影响服务性能。</p>
        <p>协程池简单理解就是有一个池子一样的东西，里面装这个固定数量的goroutine，当有一个任务到来的时候，会将这个任务交给池子里的一个空闲的goroutine去处理，如果池子里没有空闲的goroutine了，任务就会阻塞等待。所以协程池有三个角色Worker，Task，Pool。</p>
        <h3 id="属性定义"><a aria-hidden="true" tabindex="-1" href="#属性定义" class="anchor"><span class="icon icon-link"></span></a>属性定义</h3>
        <p>Worker：用于执行任务的goroutine</p>
        <p>Task: 具体的任务</p>
        <p>Pool: 池子</p>
        <h3 id="方法定义"><a aria-hidden="true" tabindex="-1" href="#方法定义" class="anchor"><span class="icon icon-link"></span></a>方法定义</h3>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">func</span> <span class="token function">NewTask</span><span class="token punctuation">(</span>funcArg <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token operator">*</span>Task 			<span class="token comment">// 创建任务</span>
</span><span class="code-line line-number" line="2">	
</span><span class="code-line line-number" line="3"><span class="token keyword">func</span> <span class="token function">NewPool</span><span class="token punctuation">(</span>workerNum <span class="token builtin">int</span><span class="token punctuation">,</span> taskNum <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>Pool		<span class="token comment">// 创建固定协程数量、任务队列长度的协程池</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">AddTask</span><span class="token punctuation">(</span>task <span class="token operator">*</span>Task<span class="token punctuation">)</span> 					<span class="token comment">// 添加任务到任务队列</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>								<span class="token comment">// </span>
</span></code><input type="hidden" value="func NewTask(funcArg func() error) *Task 			// 创建任务
	
func NewPool(workerNum int, taskNum int) *Pool		// 创建固定协程数量、任务队列长度的协程池

func (p *Pool) AddTask(task *Task) 					// 添加任务到任务队列

func (p *Pool) Run()								// 
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h3 id="使用协程池"><a aria-hidden="true" tabindex="-1" href="#使用协程池" class="anchor"><span class="icon icon-link"></span></a>使用协程池</h3>
      </markdown-style>
      <nav class="tocs">
        <aside class="inner toc">
          <ol class="tocs-list">
            <li><a href="#前置知识" class="tocs-link">前置知识</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#并发并行" class="tocs-link">并发、并行</a></li>
                <li><a href="#同步异步" class="tocs-link">同步、异步</a></li>
                <li><a href="#进程" class="tocs-link">进程</a></li>
                <li><a href="#线程" class="tocs-link">线程</a></li>
                <li><a href="#协程" class="tocs-link">协程</a></li>
              </ol>
            </li>
            <li><a href="#goroutine" class="tocs-link">Goroutine</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#是什么有什么用" class="tocs-link">是什么，有什么用</a></li>
                <li><a href="#怎么用" class="tocs-link">怎么用</a></li>
                <li><a href="#多协程异常捕获" class="tocs-link">多协程异常捕获</a></li>
              </ol>
            </li>
            <li><a href="#channel" class="tocs-link">Channel</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#是什么" class="tocs-link">是什么</a></li>
                <li><a href="#做什么" class="tocs-link">做什么</a></li>
                <li><a href="#打个球" class="tocs-link">打个球</a></li>
              </ol>
            </li>
            <li><a href="#context" class="tocs-link">Context</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#是什么用来做什么" class="tocs-link">是什么，用来做什么</a></li>
                <li><a href="#接口" class="tocs-link">接口</a>
                  <ol class="tocs-list is-collapsed">
                    <li><a href="#context-1" class="tocs-link">context</a></li>
                    <li><a href="#canceler" class="tocs-link">canceler</a></li>
                    <li><a href="#emptyctx" class="tocs-link">emptyCtx</a></li>
                    <li><a href="#cancelctx" class="tocs-link">cancelCtx</a></li>
                  </ol>
                </li>
                <li><a href="#如何使用" class="tocs-link">如何使用</a>
                  <ol class="tocs-list is-collapsed">
                    <li><a href="#contextwithcancel" class="tocs-link">context.WithCancel</a></li>
                    <li><a href="#contextwithdeadline" class="tocs-link">context.WithDeadline</a></li>
                    <li><a href="#contextwithtimeout" class="tocs-link">context.WithTimeout</a></li>
                    <li><a href="#contextwithvalue" class="tocs-link">context.WithValue</a></li>
                    <li><a href="#示例1" class="tocs-link">示例1</a></li>
                  </ol>
                </li>
              </ol>
            </li>
            <li><a href="#sync" class="tocs-link">Sync</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#waitgroup" class="tocs-link">waitGroup</a></li>
                <li><a href="#synconce" class="tocs-link">sync.Once</a></li>
                <li><a href="#synclock" class="tocs-link">sync.Lock</a></li>
                <li><a href="#死锁" class="tocs-link">死锁</a></li>
                <li><a href="#syncmap" class="tocs-link">sync.Map</a></li>
                <li><a href="#syncatomic" class="tocs-link">sync.Atomic</a></li>
              </ol>
            </li>
            <li><a href="#select" class="tocs-link">Select</a></li>
            <li><a href="#timer" class="tocs-link">Timer</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#创建timer" class="tocs-link">创建Timer</a></li>
                <li><a href="#停止timer" class="tocs-link">停止Timer</a></li>
                <li><a href="#重置timer" class="tocs-link">重置Timer</a></li>
                <li><a href="#timeafterfunc" class="tocs-link">time.AfterFunc</a></li>
                <li><a href="#timeafter" class="tocs-link">time.After</a></li>
                <li><a href="#ticker" class="tocs-link">Ticker</a></li>
              </ol>
            </li>
            <li><a href="#协程池" class="tocs-link">协程池</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#属性定义" class="tocs-link">属性定义</a></li>
                <li><a href="#方法定义" class="tocs-link">方法定义</a></li>
                <li><a href="#使用协程池" class="tocs-link">使用协程池</a></li>
              </ol>
            </li>
          </ol>
        </aside>
      </nav>
    </div>
    <script src="../js/demo-preview.js?v=1.25.0"></script>
    <div class="footer warpper">Created by <a href="https://github.com/shixiaocaia" target="_blank">shixiaocaia</a> | Powered by <a href="https://github.com/jaywcjlove/idoc" target="_blank">idoc</a><br>Think less and do more.</div>
    <script src="../js/tocbot.js?v=1.25.0"></script>
  </body>
</html>
