<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go并发编程 iDoc</title>
    <meta name="description" content="IO 密集型服务的瓶颈不在 CPU 处理速度，而在于尽可能快速的完成高并发、多连接下的数据读写。">
    <meta name="keywords" content="notebook">
    <link rel="stylesheet" type="text/css" href="../css/main.css?v=1.25.0">
    <link rel="stylesheet" type="text/css" href="../css/tocbot.css?v=1.25.0">
    <link rel="stylesheet" type="text/css" href="../css/media.css?v=1.25.0">
    <link rel="stylesheet" type="text/css" href="../css/sidebar.css?v=1.25.0">
    <link rel="stylesheet" type="text/css" href="../css/copy.css?v=1.25.0">
    <link rel="stylesheet" type="text/css" href="../css/fancybox.css?v=1.25.0">
    <link rel="icon" href="../logo.png" type="image/x-icon">
    <script src="../js/copy.js?v=1.25.0"></script>
    <script src="../js/dark-mode.js?v=1.25.0"></script>
    <script src="../js/markdown-style.js?v=1.25.0"></script>
    <script src="../js/jquery.min.js?v=1.25.0"></script>
    <script src="../js/fancybox.umd.js?v=1.25.0"></script>
  </head>
  <body><button onclick="topFunction()" id="myBtn" title="Go to top">Top</button>
    <script>
// Get the button:
let mybutton = document.getElementById("myBtn");
// When the user scrolls down 20px from the top of the document, show the button
window.onscroll = function() {scrollFunction()};
// 顶部隐藏，底部隐藏
function scrollFunction() {
if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
mybutton.style.display = "block";
} else {
mybutton.style.display = "none";
}
}
// When the user clicks on the button, scroll to the top of the document
function topFunction() {
document.body.scrollTop = 0; // For Safari
document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
}
</script>
    <header class="header">
      <article class="inner warpper"><a class="logo" href="../index.html"><img alt="iDoc logo" src="../logo.png">
<span class="title">iDoc</span></a>
        <div class="content">
          <ul class="menu">
            <li><a href="../index.html" target="" class="">Home</a></li>
            <li><a href="index.html" target="" class="active">Go</a></li>
            <li><a href="../01DataStructure/index.html" target="" class="">DataStructure</a></li>
            <li><a href="../01ComputerNetwork/index.html" target="" class="">ComputerNetwrok</a></li>
            <li><a href="../01DataBase/index.html" target="" class="">DataBase</a></li>
            <li><a href="../01OperatingSystem/index.html" target="" class="">OperatingSystem</a></li>
            <li><a href="../03Other/index.html" target="" class="">Other</a></li>
          </ul><a href="https://github.com/shixiaocaia" target="_blank" rel="noopener noreferrer" title="Github" name="Github" class="github"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
            </svg></a>
          <dark-mode permanent=""></dark-mode>
        </div>
      </article>
    </header>
    <div class="warpper-content warpper sidebar">
      <div class="sidebar-border">
        <aside class="sidebar" role="navigation">
          <div>
            <a href="index.html" class="">↩️README</a>
            <label>Hello World</label>
            <a href="ch00.html" class="">基础语法</a>
            <a href="ch01.html" class="">并发编程</a>
            <label>Todolist</label>
            <label>Web编程</label>
            <label>原理深入</label>
            <label>微服务框架</label>
          </div>
        </aside>
      </div>
      <markdown-style>
        <h1 id="go并发编程"><a aria-hidden="true" tabindex="-1" href="#go并发编程" class="anchor"><span class="icon icon-link"></span></a>Go并发编程</h1>
        <h2 id="前置知识"><a aria-hidden="true" tabindex="-1" href="#前置知识" class="anchor"><span class="icon icon-link"></span></a>前置知识</h2>
        <ul>
          <li>
            <h3 id="并发并行"><a aria-hidden="true" tabindex="-1" href="#并发并行" class="anchor"><span class="icon icon-link"></span></a>并发、并行</h3>
            <ul>
              <li>并发：在并发中，这些任务可以在同一个时间段内<strong>交替执行</strong>，每个任务都有可能在任意时刻被暂停或切换，以便给其他任务执行的机会。并发可以提高系统的吞吐量和资源利用率，但并不一定意味着同时进行多个任务的实际并行执行。</li>
              <li>并行：指系统中多个任务同时进行实际的并发执行，每个任务都有自己的执行线程或处理器核心。在并行中，多个任务可以<strong>同时进行</strong>，彼此之间<strong>相互独立</strong>，互不干扰。并行可以通过多核处理器、分布式系统等实现，以提高任务的执行速度和效率。</li>
            </ul>
          </li>
        </ul>
        <h3 id="进程"><a aria-hidden="true" tabindex="-1" href="#进程" class="anchor"><span class="icon icon-link"></span></a>进程</h3>
        <ul>
          <li>进程是程序执行的过程，包括了动态创建、调度和消亡的整个过程，进程是程序资源管理的最小单位。</li>
          <li>进程通常管理包括内存资源、IO资源、信号处理等部分。
            <ul>
              <li>内存管理，采用虚拟内存技术，把进程虚拟地址空间划分成<strong>用户空间和内核空间</strong>。</li>
            </ul>
          </li>
        </ul>
        <h3 id="线程"><a aria-hidden="true" tabindex="-1" href="#线程" class="anchor"><span class="icon icon-link"></span></a>线程</h3>
        <ul>
          <li>线程是操作操作系统能够进行运算调度的最小单位。<strong>线程被包含在进程之中</strong>，是进程中的实际运作单位，一个进程内可以包含多个线程，线程是资源调度的最小单位。</li>
          <li>同一进程中的多条线程共享该进程中的全部系统资源，如虚拟地址空间，文件描述符文件描述符和信号处理等等。</li>
          <li>同一进程中的多个线程有各自的调用栈、寄存器环境、线程本地存储等信息。</li>
          <li>线程间切换
            <ul>
              <li>线程是被内核所调度，线程被调度切换到另一个线程上下文的时候，需要保存一个用户线程的状态到内存</li>
              <li>恢复另一个线程状态到寄存器，然后更新调度器的数据结构，这几步操作涉及<strong>用户态到内核态转换</strong>，开销比较多。</li>
            </ul>
          </li>
        </ul>
        <h3 id="协程"><a aria-hidden="true" tabindex="-1" href="#协程" class="anchor"><span class="icon icon-link"></span></a>协程</h3>
        <p>IO 密集型服务的瓶颈不在 CPU 处理速度，而在于尽可能<strong>快速的完成高<strong><strong>并发</strong></strong>、多连接下的数据读写</strong>。</p>
        <ul>
          <li>如果用多线程，高并发场景的大量 IO 等待会导致多线程被频繁挂起和切换，非常消耗系统资源，同时多线程访问共享资源存在竞争问题。</li>
          <li>如果用多进程，不仅存在频繁调度切换问题，同时还会存在每个进程资源不共享的问题，需要额外引入进程间通信机制来解决。</li>
        </ul>
        <p>协程 Coroutines 是一种比线程更加轻量级的<strong>微线程</strong>。类比一个进程可以拥有多个线程，一个线程也可以拥有多个协程，因此协程又称微线程和纤程。</p>
        <ul>
          <li>协程间切换
            <ul>
              <li>调度完全由用户控制，协程拥有自己的寄存器上下文和栈，协程调度切换时，将寄存器上下文和栈保存到其他地方</li>
              <li>在切回来的时候，恢复先前保存的寄存器上下文和栈，直接操作用户空间栈，<strong>完全没有内核切换</strong>的开销。</li>
            </ul>
          </li>
          <li>动态协程栈
            <ul>
              <li>Goroutine 的栈只有 2KB大小，而且是动态伸缩的，可以按需调整大小，最大可达 1G。</li>
              <li>相比之下，线程也都有一个固定大小的内存块来做栈，一般会是 2MB 大小，线程栈会用来存储线程上下文信息。2MB 的线程栈和协程栈相比大了很多。</li>
            </ul>
          </li>
        </ul>
        <h2 id="groutine"><a aria-hidden="true" tabindex="-1" href="#groutine" class="anchor"><span class="icon icon-link"></span></a>Groutine</h2>
        <h3 id="是什么有什么用"><a aria-hidden="true" tabindex="-1" href="#是什么有什么用" class="anchor"><span class="icon icon-link"></span></a>是什么，有什么用</h3>
        <p>协程是轻量级的线程，与传统的进程和线程相比，协程的最大特点是 "轻"！可以轻松创建上百万个协程而不会导致系统资源衰竭。</p>
        <h3 id="怎么用"><a aria-hidden="true" tabindex="-1" href="#怎么用" class="anchor"><span class="icon icon-link"></span></a>怎么用</h3>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">    <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="5">    <span class="token string">"sync"</span>
</span><span class="code-line line-number" line="6">    <span class="token string">"time"</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">func</span> <span class="token function">say</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"I am done ! id: "</span> <span class="token operator">+</span> id<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//wg中值 - 1</span>
</span><span class="code-line line-number" line="13"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// wait two groutines</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21">    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">       fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">       wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">    <span class="token keyword">go</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 等待所有任务完成，卡住如果wg不是0</span>
</span><span class="code-line line-number" line="29">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exit"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
    &#x22;fmt&#x22;
    &#x22;sync&#x22;
    &#x22;time&#x22;
)

func say(id string) {
    time.Sleep(time.Second)
    fmt.Println(&#x22;I am done ! id: &#x22; + id)
    wg.Done() //wg中值 - 1
}

var wg sync.WaitGroup

func main() {

    wg.Add(2) // wait two groutines

    go func(id string) {
       fmt.Println(id)
       wg.Done()
    }(&#x22;hello&#x22;)

    go say(&#x22;Hello&#x22;)

    wg.Wait() // 等待所有任务完成，卡住如果wg不是0
    fmt.Println(&#x22;exit&#x22;)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>定义一个WaitGroup， wg.Add告知要等待执行的任务，wg.Done在完成后减少计数，wg.Wait挂起</li>
          <li>匿名函数也可以使用Groutine</li>
        </ul>
        <h2 id="channel"><a aria-hidden="true" tabindex="-1" href="#channel" class="anchor"><span class="icon icon-link"></span></a>Channel</h2>
        <ul>
          <li>可以把它看成一个管道，通过它并发核心单元就可以发送或者接收数据进行通讯(communication)。它的操作符是箭头 <strong>&#x3C;-</strong> 。</li>
        </ul>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1">ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2">ch <span class="token operator">&#x3C;-</span> v <span class="token comment">// 发送值v到Channel ch中</span>
</span><span class="code-line line-number" line="3">v <span class="token operator">:=</span> <span class="token operator">&#x3C;-</span>ch <span class="token comment">// 从Channel中接受值</span>
</span></code><input type="hidden" value="ch := make(chan int)
ch <- v // 发送值v到Channel ch中
v := <-ch // 从Channel中接受值
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>Channel是可以定义方向的，单向接受或者发送数据，双向。</li>
        </ul>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">chan</span> T          <span class="token comment">// 可以接收和发送类型为 T 的数据</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">chan</span><span class="token operator">&#x3C;-</span> <span class="token builtin">float64</span>  <span class="token comment">// 只可以用来发送 float64 类型的数据</span>
</span><span class="code-line line-number" line="3"><span class="token operator">&#x3C;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span>      <span class="token comment">// 只可以用来接收 int 类型的数据</span>
</span></code><input type="hidden" value="chan T          // 可以接收和发送类型为 T 的数据
chan<- float64  // 只可以用来发送 float64 类型的数据
<-chan int      // 只可以用来接收 int 类型的数据
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>Channel可以分为有缓冲的和无缓冲的</li>
          <li>无缓存的channel只有在receiver准备好后send才被执行。如果有缓存，并且缓存未满，则send会被执行。</li>
        </ul>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2"><span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</span></code><input type="hidden" value="make(chan int, 0)
make(chan int, 100)
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>Channel 可以通过close函数关闭</li>
          <li>在多个goroutine从/往 一个channel 中 receive/send 数据, 不必考虑额外的同步措施。</li>
          <li>Channel可以作为一个先入先出(FIFO)的队列，接收的数据和发送的数据的顺序是一致的。</li>
          <li>如果channel c已经被关闭,继续往它发送数据会导致<code>panic: send on closed channel</code>:
            <ul>
              <li>通常<code>x, ok := &#x3C;-ch</code>检查通道是否被关闭</li>
              <li>往nil channel中发送数据会一致被阻塞着</li>
              <li>从这个关闭的channel中不但可以读取出已发送的数据，还可以不断的读取零值</li>
              <li>如果通过<code>range</code>读取，channel关闭后for循环会跳出</li>
            </ul>
          </li>
          <li>默认情况下，发送和接收会一直阻塞着，直到另一方准备好。这种方式可以用来在gororutine中进行同步，而不必使用显示的锁或者条件变量。</li>
        </ul>
        <h3 id="打个球"><a aria-hidden="true" tabindex="-1" href="#打个球" class="anchor"><span class="icon icon-link"></span></a>打个球</h3>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">    <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="5">    <span class="token string">"math/rand"</span>
</span><span class="code-line line-number" line="6">    <span class="token string">"sync"</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">func</span> <span class="token function">player</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">    <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12">    <span class="token keyword">for</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="13">       ball<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&#x3C;-</span>ch <span class="token comment">//怎么样从通道里拿值</span>
</span><span class="code-line line-number" line="14">       <span class="token comment">// 如果通道被关闭，err，如果为空没有值，会阻塞</span>
</span><span class="code-line line-number" line="15">       <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="16">          fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"channel is closed! %s wins\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">          <span class="token keyword">return</span>
</span><span class="code-line line-number" line="18">       <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">       n <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">       <span class="token keyword">if</span> n<span class="token operator">%</span><span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">          <span class="token comment">// 把球打飞</span>
</span><span class="code-line line-number" line="23">          <span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">          fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s misses the ball ! %s loses\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">          <span class="token keyword">return</span>
</span><span class="code-line line-number" line="26">       <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="27">       ball<span class="token operator">++</span>
</span><span class="code-line line-number" line="28">       fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s receives ball %d\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> ball<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">       ch <span class="token operator">&#x3C;-</span> ball
</span><span class="code-line line-number" line="30">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="31"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="32">
</span><span class="code-line line-number" line="33"><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
</span><span class="code-line line-number" line="34">
</span><span class="code-line line-number" line="35"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="36">
</span><span class="code-line line-number" line="37">    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// wait two groutines</span>
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39">    ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="40">
</span><span class="code-line line-number" line="41">    <span class="token comment">//ch &#x3C;- 0 //error</span>
</span><span class="code-line line-number" line="42">    
</span><span class="code-line line-number" line="43">    <span class="token keyword">go</span> <span class="token function">player</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="44">    <span class="token keyword">go</span> <span class="token function">player</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="45">
</span><span class="code-line line-number" line="46">    ch <span class="token operator">&#x3C;-</span> <span class="token number">0</span>
</span><span class="code-line line-number" line="47">    <span class="token comment">// 先生成goroutine，再传球</span>
</span><span class="code-line line-number" line="48">    <span class="token comment">// 必须保证channel有人接受（传球）</span>
</span><span class="code-line line-number" line="49">
</span><span class="code-line line-number" line="50">    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 等待所有任务完成，卡住如果wg不是0</span>
</span><span class="code-line line-number" line="51">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exit"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="52"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
    &#x22;fmt&#x22;
    &#x22;math/rand&#x22;
    &#x22;sync&#x22;
)

func player(name string, ch chan int) {
    defer wg.Done()

    for {
       ball, ok := <-ch //怎么样从通道里拿值
       // 如果通道被关闭，err，如果为空没有值，会阻塞
       if !ok {
          fmt.Printf(&#x22;channel is closed! %s wins\n&#x22;, name)
          return
       }

       n := rand.Intn(100)
       if n%10 == 0 {
          // 把球打飞
          close(ch)
          fmt.Printf(&#x22;%s misses the ball ! %s loses\n&#x22;, name, name)
          return
       }
       ball++
       fmt.Printf(&#x22;%s receives ball %d\n&#x22;, name, ball)
       ch <- ball
    }
}

var wg sync.WaitGroup

func main() {

    wg.Add(2) // wait two groutines

    ch := make(chan int, 0)

    //ch <- 0 //error
    
    go player(&#x22;A&#x22;, ch)
    go player(&#x22;B&#x22;, ch)

    ch <- 0
    // 先生成goroutine，再传球
    // 必须保证channel有人接受（传球）

    wg.Wait() // 等待所有任务完成，卡住如果wg不是0
    fmt.Println(&#x22;exit&#x22;)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h2 id="context"><a aria-hidden="true" tabindex="-1" href="#context" class="anchor"><span class="icon icon-link"></span></a>Context</h2>
        <ul>
          <li>理解Context的使用场景；
            <ul>
              <li>context 用来解决 goroutine 之间<code>退出通知</code>、<code>元数据传递</code>的功能。</li>
            </ul>
          </li>
          <li>熟悉Context的接口；
            <ul>
              <li><code>Context</code> 是一个接口，定义了 4 个方法，它们都是<code>幂等</code>的。也就是说连续多次调用同一个方法，得到的结果都是相同的。</li>
            </ul>
          </li>
          <li><strong>实践：使用Context传递traceId</strong></li>
        </ul>
        <h3 id="是什么用来做什么"><a aria-hidden="true" tabindex="-1" href="#是什么用来做什么" class="anchor"><span class="icon icon-link"></span></a>是什么，用来做什么</h3>
        <ul>
          <li>context 主要用来在 goroutine 之间传递上下文信息，包括：取消信号、超时时间、截止时间、k-v 等。
            <ul>
              <li>当请求被取消或是处理时间太长，这有可能是使用者关闭了浏览器或是已经超过了请求方规定的超时时间，请求方直接放弃了这次请求结果。</li>
              <li>这时，所有正在为这个请求工作的 goroutine 需要快速退出，因为它们的“工作成果”不再被需要了。</li>
              <li>在相关联的 goroutine 都退出后，系统就可以回收相关的资源。</li>
            </ul>
          </li>
          <li>在Go里不能Go里不能杀死协程，协程的关闭一般会用 <code>channel+select</code> 方式来控制。
            <ul>
              <li>在某些场景下，例如处理一个请求衍生了很多协程，这些协程之间是相互关联的：需要共享一些全局变量、有共同的 deadline 等，而且可以同时被关闭。</li>
              <li>再用 <code>channel+select</code> 就会比较麻烦，这时就可以通过 context 来实现。</li>
            </ul>
          </li>
        </ul>
        <h3 id="接口"><a aria-hidden="true" tabindex="-1" href="#接口" class="anchor"><span class="icon icon-link"></span></a>接口</h3>
        <h4 id="context-1"><a aria-hidden="true" tabindex="-1" href="#context-1" class="anchor"><span class="icon icon-link"></span></a>Context</h4>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">    <span class="token comment">// 当 context 被取消或者到了 deadline，返回一个被关闭的 channel</span>
</span><span class="code-line line-number" line="3">    <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">    <span class="token comment">// 在 channel Done 关闭后，返回 context 取消原因</span>
</span><span class="code-line line-number" line="6">    <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">    <span class="token comment">// 返回 context 是否会被取消以及自动取消时间（即 deadline）</span>
</span><span class="code-line line-number" line="9">    <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">    <span class="token comment">// 获取 key 对应的 value</span>
</span><span class="code-line line-number" line="12">    <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="13"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="type Context interface {
    // 当 context 被取消或者到了 deadline，返回一个被关闭的 channel
    Done() <-chan struct{}

    // 在 channel Done 关闭后，返回 context 取消原因
    Err() error

    // 返回 context 是否会被取消以及自动取消时间（即 deadline）
    Deadline() (deadline time.Time, ok bool)

    // 获取 key 对应的 value
    Value(key interface{}) interface{}
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li><code>Context</code> 是一个接口，定义了 4 个方法，它们都是<code>幂等</code>的。也就是说连续多次调用同一个方法，得到的结果都是相同的。</li>
          <li><code>Done() &#x3C;-chan struct{}</code>这里返回是一个只读的Channel，对于没有传递值的Channel，读不出任何的值，当Channel关闭时，可以读取0，作为channel关闭的信号，表明要尽快做退出处理。</li>
          <li><code>Err()</code> 返回一个错误，表示 channel 被关闭的原因。例如是被取消，还是超时。</li>
          <li><code>Deadline()</code> 返回 context 的截止时间，通过此时间，函数就可以决定是否进行接下来的操作，如果时间太短，就可以不往下做了，否则浪费系统资源。当然，也可以用这个 deadline 来设置一个 I/O 操作的超时时间。</li>
          <li><code>Value()</code> 获取之前设置的 key 对应的 value。</li>
        </ul>
        <h4 id="canceler"><a aria-hidden="true" tabindex="-1" href="#canceler" class="anchor"><span class="icon icon-link"></span></a>canceler</h4>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">type</span> canceler <span class="token keyword">interface</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">    <span class="token function">cancel</span><span class="token punctuation">(</span>removeFromParent <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">    <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="4"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="type canceler interface {
    cancel(removeFromParent bool, err error)
    Done() <-chan struct{}
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>实现上面定义的两个方法的Context，表明该Context是可以取消的</li>
          <li>为什么这样设计
            <ul>
              <li>“取消”操作应该是建议性，而非强制性。只有实现了这个接口，Context才会是可取消的。caller 不应该去关心、干涉 callee 的情况，决定如何以及何时 return 是 callee 的责任。caller 只需发送“取消”信息，callee 根据收到的信息来做进一步的决策，因此接口并没有定义 cancel 方法。</li>
              <li>“取消”操作应该可传递。“取消”某个函数时，和它相关联的其他函数也应该“取消”。因此，<code>Done()</code> 方法返回一个只读的 channel，所有相关函数监听此 channel。一旦 channel 关闭，通过 channel 的“广播机制”，所有监听者都能收到。</li>
            </ul>
          </li>
        </ul>
        <h4 id="emptyctx"><a aria-hidden="true" tabindex="-1" href="#emptyctx" class="anchor"><span class="icon icon-link"></span></a>emptyCtx</h4>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">type</span> emptyCtx <span class="token builtin">int</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="4">    <span class="token keyword">return</span>
</span><span class="code-line line-number" line="5"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="8">    <span class="token keyword">return</span> <span class="token boolean">nil</span>
</span><span class="code-line line-number" line="9"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">    <span class="token keyword">return</span> <span class="token boolean">nil</span>
</span><span class="code-line line-number" line="13"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="16">    <span class="token keyword">return</span> <span class="token boolean">nil</span>
</span><span class="code-line line-number" line="17"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="type emptyCtx int

func (*emptyCtx) Deadline() (deadline time.Time, ok bool) {
    return
}

func (*emptyCtx) Done() <-chan struct{} {
    return nil
}

func (*emptyCtx) Err() error {
    return nil
}

func (*emptyCtx) Value(key interface{}) interface{} {
    return nil
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>这是一个空的 context，永远不会被 cancel，没有存储值，也没有 deadline。</li>
        </ul>
        <p>通常被包装后，通过两个导出函数导出</p>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">var</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    background <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>emptyCtx<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">    todo       <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>emptyCtx<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment">// 注意首字母大写</span>
</span><span class="code-line line-number" line="7"><span class="token keyword">func</span> <span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Context <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="8">    <span class="token keyword">return</span> background
</span><span class="code-line line-number" line="9"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token keyword">func</span> <span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Context <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">    <span class="token keyword">return</span> todo
</span><span class="code-line line-number" line="13"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="var (
    background = new(emptyCtx)
    todo       = new(emptyCtx)
)

// 注意首字母大写
func Background() Context {
    return background
}

func TODO() Context {
    return todo
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>background 通常用在 main 函数中，作为所有 context 的根节点。</li>
          <li>todo 通常用在并不知道传递什么 context的情形。例如，调用一个需要传递 context 参数的函数，你手头并没有其他 context 可以传递，这时就可以传递 todo。这常常发生在重构进行中，给一些函数添加了一个 Context 参数，但不知道要传什么，就用 todo “占个位子”，最终要换成其他 context。</li>
        </ul>
        <h4 id="cancelctx"><a aria-hidden="true" tabindex="-1" href="#cancelctx" class="anchor"><span class="icon icon-link"></span></a>cancelCtx</h4>
        <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">type</span> cancelCtx <span class="token keyword">struct</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">    Context
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token comment">// 保护之后的字段</span>
</span><span class="code-line line-number" line="5">    mu       sync<span class="token punctuation">.</span>Mutex
</span><span class="code-line line-number" line="6">    done     <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="7">    children <span class="token keyword">map</span><span class="token punctuation">[</span>canceler<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="8">    err      <span class="token builtin">error</span>
</span><span class="code-line line-number" line="9"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="type cancelCtx struct {
    Context

    // 保护之后的字段
    mu       sync.Mutex
    done     chan struct{}
    children map[canceler]struct{}
    err      error
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <p>一个可以取消的 Context，实现了 canceler 接口。它直接将接口 Context 作为它的一个匿名字段，这样，它就可以被看成一个 Context。</p>
        <h3 id="如何使用"><a aria-hidden="true" tabindex="-1" href="#如何使用" class="anchor"><span class="icon icon-link"></span></a>如何使用</h3>
        <ul>
          <li>
            <p>源码里对外提供了一个创建根节点 context 的函数</p>
            <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">func</span> <span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Context
</span></code><input type="hidden" value="func Background() Context
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
            <ul>
              <li>background 是一个空的 context， 它不能被取消，没有值，也没有超时时间。</li>
            </ul>
          </li>
          <li>
            <p>有了根节点 context，又提供了四个函数创建子节点 context：</p>
            <pre class="language-go"><code class="language-go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">func</span> <span class="token function">WithCancel</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctx Context<span class="token punctuation">,</span> cancel CancelFunc<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">func</span> <span class="token function">WithDeadline</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3"><span class="token keyword">func</span> <span class="token function">WithTimeout</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4"><span class="token keyword">func</span> <span class="token function">WithValue</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> Context
</span></code><input type="hidden" value="func WithCancel(parent Context) (ctx Context, cancel CancelFunc)
func WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc)
func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)
func WithValue(parent Context, key, val interface{}) Context
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
            <ul>
              <li>context 会在函数传递间传递。只需要在适当的时间调用 cancel 函数向 goroutines 发出取消信号或者调用 Value 函数取出 context 中的值。</li>
            </ul>
          </li>
          <li>
            <p>使用建议</p>
            <ul>
              <li>
                <p>不要将 Context 塞到结构体里。直接将 Context 类型作为函数的第一参数，而且一般都命名为 ctx。</p>
              </li>
              <li>
                <p>不要向函数传入一个 nil 的 context，如果你实在不知道传什么，标准库给你准备好了一个 context：todo。</p>
              </li>
              <li>
                <p>不要把本应该作为函数参数的类型塞到 context 中，context 存储的应该是一些共同的数据。例如：登陆的 session、cookie 等。</p>
              </li>
              <li>
                <p>同一个 context 可能会被传递到多个 goroutine，别担心，context 是并发安全的。</p>
              </li>
            </ul>
          </li>
        </ul>
        <h2 id="sync"><a aria-hidden="true" tabindex="-1" href="#sync" class="anchor"><span class="icon icon-link"></span></a>Sync</h2>
        <h2 id="timer"><a aria-hidden="true" tabindex="-1" href="#timer" class="anchor"><span class="icon icon-link"></span></a>Timer</h2>
        <h2 id="竞争"><a aria-hidden="true" tabindex="-1" href="#竞争" class="anchor"><span class="icon icon-link"></span></a>竞争</h2>
        <h3 id="mutex"><a aria-hidden="true" tabindex="-1" href="#mutex" class="anchor"><span class="icon icon-link"></span></a>Mutex</h3>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">    <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="5">    <span class="token string">"sync"</span>
</span><span class="code-line line-number" line="6">    <span class="token string">"sync/atomic"</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
</span><span class="code-line line-number" line="10"><span class="token keyword">var</span> counter <span class="token builtin">int32</span>
</span><span class="code-line line-number" line="11"><span class="token keyword">var</span> mtx sync<span class="token punctuation">.</span>Mutex
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token keyword">func</span> <span class="token function">UnsafeIncCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="14">    <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">    <span class="token comment">//race condition here 竞争条件</span>
</span><span class="code-line line-number" line="16">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="17">       mtx<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">       counter<span class="token operator">++</span> <span class="token comment">// 共享资源，统一时间只有一个协程在操作</span>
</span><span class="code-line line-number" line="19">       mtx<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="21">    <span class="token comment">// 这个过程中包括了读值、+1、赋值，这个过程中在多个协程之间交替执行，出现竞争</span>
</span><span class="code-line line-number" line="22"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="23"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25">    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// wait two groutines</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27">    <span class="token comment">//go UnsafeIncCounter()</span>
</span><span class="code-line line-number" line="28">    <span class="token comment">//go UnsafeIncCounter()</span>
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">    <span class="token keyword">go</span> <span class="token function">AtomicIncCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="31">    <span class="token keyword">go</span> <span class="token function">AtomicIncCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">
</span><span class="code-line line-number" line="33">    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 等待所有任务完成，卡住如果wg不是0</span>
</span><span class="code-line line-number" line="34">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="35">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exit"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="36"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
    &#x22;fmt&#x22;
    &#x22;sync&#x22;
    &#x22;sync/atomic&#x22;
)

var wg sync.WaitGroup
var counter int32
var mtx sync.Mutex

func UnsafeIncCounter() {
    defer wg.Done()
    //race condition here 竞争条件
    for i := 0; i < 10000; i++ {
       mtx.Lock()
       counter++ // 共享资源，统一时间只有一个协程在操作
       mtx.Unlock()
    }
    // 这个过程中包括了读值、+1、赋值，这个过程中在多个协程之间交替执行，出现竞争
}
func main() {

    wg.Add(2) // wait two groutines

    //go UnsafeIncCounter()
    //go UnsafeIncCounter()

    go AtomicIncCounter()
    go AtomicIncCounter()

    wg.Wait() // 等待所有任务完成，卡住如果wg不是0
    fmt.Println(counter)
    fmt.Println(&#x22;exit&#x22;)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h3 id="atomic"><a aria-hidden="true" tabindex="-1" href="#atomic" class="anchor"><span class="icon icon-link"></span></a>Atomic</h3>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">func</span> <span class="token function">AtomicIncCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">    <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">    <span class="token comment">//race condition here 竞争条件</span>
</span><span class="code-line line-number" line="4">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">       <span class="token comment">//sync safe</span>
</span><span class="code-line line-number" line="6">       atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span>counter<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 共享资源，统一时间只有一个协程在操作</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="9">    <span class="token comment">// 这个过程中包括了读值、+1、赋值，这个过程中在多个协程之间交替执行，出现竞争</span>
</span><span class="code-line line-number" line="10"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="func AtomicIncCounter() {
    defer wg.Done()
    //race condition here 竞争条件
    for i := 0; i < 10000; i++ {
       //sync safe
       atomic.AddInt32(&#x26;counter, 1) // 共享资源，统一时间只有一个协程在操作

    }
    // 这个过程中包括了读值、+1、赋值，这个过程中在多个协程之间交替执行，出现竞争
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <h3 id="channel-1"><a aria-hidden="true" tabindex="-1" href="#channel-1" class="anchor"><span class="icon icon-link"></span></a>Channel</h3>
        <ul>
          <li>有缓冲无缓冲，分别解决什么问题？</li>
          <li>Channel底层原理。</li>
        </ul>
        <pre class="language-go"><code class="language-Go code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">package</span> main
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">    <span class="token string">"fmt"</span>
</span><span class="code-line line-number" line="5">    <span class="token string">"sync"</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
</span><span class="code-line line-number" line="9"><span class="token keyword">var</span> counter <span class="token builtin">int32</span>
</span><span class="code-line line-number" line="10"><span class="token keyword">var</span> mtx sync<span class="token punctuation">.</span>Mutex
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token keyword">var</span> ch <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14"><span class="token keyword">func</span> <span class="token function">ChannelIncCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="15">    <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="17">       count <span class="token operator">:=</span> <span class="token operator">&#x3C;-</span>ch
</span><span class="code-line line-number" line="18">       count<span class="token operator">++</span>
</span><span class="code-line line-number" line="19">       ch <span class="token operator">&#x3C;-</span> count
</span><span class="code-line line-number" line="20">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="21"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="22"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// wait two groutines</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">    <span class="token keyword">go</span> <span class="token function">ChannelIncCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">    <span class="token keyword">go</span> <span class="token function">ChannelIncCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">
</span><span class="code-line line-number" line="29">    ch <span class="token operator">&#x3C;-</span> <span class="token number">0</span> <span class="token comment">// 保证有人接球，避免死锁</span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31">    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 等待所有任务完成，卡住如果wg不是0</span>
</span><span class="code-line line-number" line="32">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&#x3C;-</span>ch<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exit"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="34"><span class="token punctuation">}</span>
</span></code><input type="hidden" value="package main

import (
    &#x22;fmt&#x22;
    &#x22;sync&#x22;
)

var wg sync.WaitGroup
var counter int32
var mtx sync.Mutex

var ch = make(chan int, 1)

func ChannelIncCounter() {
    defer wg.Done()
    for i := 0; i < 10000; i++ {
       count := <-ch
       count++
       ch <- count
    }
}
func main() {

    wg.Add(2) // wait two groutines

    go ChannelIncCounter()
    go ChannelIncCounter()

    ch <- 0 // 保证有人接球，避免死锁

    wg.Wait() // 等待所有任务完成，卡住如果wg不是0
    fmt.Println(<-ch)
    fmt.Println(&#x22;exit&#x22;)
}
"><div onclick="copied(this)" class="copied"><svg class="octicon-copy" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path><path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path></svg><svg class="octicon-check" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" height="12" width="12"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg></div></pre>
        <ul>
          <li>注意这里是channel是有缓存通道，否则会产生死锁</li>
          <li>无缓存通道必须有人接受</li>
        </ul>
        <ol>
          <li>主routine在等待wg.Wait()执行完毕，才能执行 fmt.Println(count&#x3C;-ch)</li>
          <li>另外两个routine中较慢的一个叫做慢routine。慢routine在最后一次循环执行 ch &#x3C;- count时，必须得有人接收才行，目前唯一有接收能力的语句就是主routine中的 fmt.Println(count&#x3C;-ch)，但是fmt.Println(count&#x3C;-ch)必须在慢routine执行完毕后才能执行，因此deadlock了</li>
        </ol>
      </markdown-style>
      <nav class="tocs">
        <aside class="inner toc">
          <ol class="tocs-list">
            <li><a href="#前置知识" class="tocs-link">前置知识</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#并发并行" class="tocs-link">并发、并行</a></li>
                <li><a href="#进程" class="tocs-link">进程</a></li>
                <li><a href="#线程" class="tocs-link">线程</a></li>
                <li><a href="#协程" class="tocs-link">协程</a></li>
              </ol>
            </li>
            <li><a href="#groutine" class="tocs-link">Groutine</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#是什么有什么用" class="tocs-link">是什么，有什么用</a></li>
                <li><a href="#怎么用" class="tocs-link">怎么用</a></li>
              </ol>
            </li>
            <li><a href="#channel" class="tocs-link">Channel</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#打个球" class="tocs-link">打个球</a></li>
              </ol>
            </li>
            <li><a href="#context" class="tocs-link">Context</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#是什么用来做什么" class="tocs-link">是什么，用来做什么</a></li>
                <li><a href="#接口" class="tocs-link">接口</a>
                  <ol class="tocs-list is-collapsed">
                    <li><a href="#context-1" class="tocs-link">Context</a></li>
                    <li><a href="#canceler" class="tocs-link">canceler</a></li>
                    <li><a href="#emptyctx" class="tocs-link">emptyCtx</a></li>
                    <li><a href="#cancelctx" class="tocs-link">cancelCtx</a></li>
                  </ol>
                </li>
                <li><a href="#如何使用" class="tocs-link">如何使用</a></li>
              </ol>
            </li>
            <li><a href="#sync" class="tocs-link">Sync</a></li>
            <li><a href="#timer" class="tocs-link">Timer</a></li>
            <li><a href="#竞争" class="tocs-link">竞争</a>
              <ol class="tocs-list is-collapsed">
                <li><a href="#mutex" class="tocs-link">Mutex</a></li>
                <li><a href="#atomic" class="tocs-link">Atomic</a></li>
                <li><a href="#channel-1" class="tocs-link">Channel</a></li>
              </ol>
            </li>
          </ol>
        </aside>
      </nav>
    </div>
    <script src="../js/demo-preview.js?v=1.25.0"></script>
    <div class="footer warpper">Created by <a href="https://github.com/shixiaocaia" target="_blank">shixiaocaia</a> | Powered by <a href="https://github.com/jaywcjlove/idoc" target="_blank">idoc</a><br>Think less and do more.</div>
    <script src="../js/tocbot.js?v=1.25.0"></script>
  </body>
</html>
