程序是怎么跑起来的
===

## 对程序员而言CPU是什么

1. 熟悉常用的一些寄存器的作用
2. 机器语言

> 机器语言是计算机能直接编译运行的语言，高级语言经过编译转换为机器语言。
>
> 机器语言主要实现：
>
> > 1. 数据在主存、寄存器、磁盘之间的传送指令、
> > 2. 运算指令
> > 3. 跳转指令，实现条件分支，循环，强制跳转
> > 4. call return指令

3. 32位是多少个字节，4个字节

## 数据使用二进制数表示的

计算机内部是由各类的IC电子部件构成的，IC所有的引脚只有直流电压0V或者5V（部分引脚电压小于5V），这样的两个状态对应了计算机内部中信息数据只能用二进制处理。

二进制位数一般是8的倍数，对应着1个字节，所以计算机处理的信息基本单位是8的二进制数。

如果部分数据不到8位，一般在高位补0。

**区分逻辑右移和算数右移**

只有右移才需要区分。

- 逻辑右移，高位不足是用0填补。
- 算数右移，高位不足用移位前的符号位进行填补。

## 熟练使用有棱有角的内存

内存的实体是内存IC，一个内存IC中的地址信号引脚有10个，对应可以保存2^10 = 1024的地址，地址是用来表示数据的存储场，因此可以得出这个内存IC可以存储1024个字节的数据。

磁盘中的程序必须加载到内存中才能运行。

> 负责解析和运行程序内容的CPU，需要通过内部程序计数器来指定内存地址，然后才能读出程序。

### 虚拟内存

磁盘和内存的关系之二，使用一部分的磁盘空间作为内存使用。将需要执行的部分程序加载内存中，其他部分置换到磁盘当中。

虚拟内存的方法分为分页式和分段式。

为了实现虚拟内存的功能，Windows在磁盘上提供虚拟内存用的文件，由系统自动做成和管理。

但是虚拟内存不能从根本上解决内存不足的问题：1. 增加内存 ，2. 节约内存使用。

- 通过DDL文件实现函数共有，从而节省内存。将多个文件需要的函数作为独立的DDL文件，进行动态链接调用，节省内存。
  - 操作系统本身也就是多个DLL文件的集合体。
- 通过_stdcall来减小程序文件的大小
  - 通过栈清理处理将不需要的数据从接受和传递函数的参数从内存上的栈区域中清理出去，程序编译时由编译器自动附加导程序main中。

## 试着压缩数据

文件的大小之所以用XXKB，XXMB来表示是因为文件是以字节B为单位保存的。

### RLE算法

Run lenght Encoding算法，按照数据×重复次数形式表示压缩算法，比起AAA，A3只需要两个字节表示。

但这并不适合文字压缩，真正文字连续重复出现的很少。

### 哈夫曼算法

*莫尔斯编码*是通过滴答长短点来传递文本消息的。一般讲文中出现频率搞得字符用短编码表示，通过长短码表示字符，替代直接用1个英文版半圆角字符为1个字节存储的方法。实际压缩率并不高。

*哈夫曼编码*是为各压缩对象文件分别构造最佳的编码体系，并以该编码体系为基础进行压缩。

哈夫曼编码中间需要加入间隔符，来区分字符，但是在实际当中我们是通过哈夫曼树构造编码体系，不需要字符区分符号。

使用哈夫曼树后，出现频率越高的数据所占用的数据位数就越少，数据的区分也越明显。

## 程序是在何种环境中运行的

运行环境 = 操作系统 + 硬件。

JAVA虚拟机是一边把JAVA字节代码注意转换为本地代码一边运行的，虚拟JAVA虚拟可以用在Window，PDA等各种操作系统上。

程序运行的环境中存在BIOS（Basic Input / Output System）的系统，BISO存储在ROM中，是预先内置在计算机主机内部的程序。其内部包好了键盘、磁盘、显卡等基本控制程序，还有引导程序。

在开机后，BIOS会确认硬件是否正常运行，没有问题启动引导程序。引导程序就把硬盘等记录的OS加载到内存中运行。

## 从源文件到可执行文件

源文件经过**编译**得到目标文件，多个目标文件**链接**成一个可执行文件。

- CPU能够直接解析的是机器语言代码（本地代码）。
- 把EXE文件内容，每个字节用2位十六进制数表示，所以用记事本打开EXE文件是各种数值罗列。
- 也就是说计算机就是把所有信息作为数值的集合来处理。

### 库文件

是把多个目标文件集成保存到一个文件中的形式。

链接器会指定库文件后，就会从中把需要的文件从目标文件中提取出来。

> 例如`sprintf()`等函数是通过目标文件链接的。
>
> 通过包含多个目标文件的库文件来提供函数，这样就可以不公开源代码。

### API

Windows以函数形式为应用提供功能，也就是API接口，例如`MessageBox()`提供了显示消息框的功能。

API通常保存在DLL文件的特殊库文件当中。

`import32.lib`这样库文件称为导入库，并不包含实际的目标文件实体。

而存储目标文件实体，并且直接和EXE文件结合的库文件形式称为*静态链接库*，例如cw32lib就是，存放了`sprintf()`目标文件。

### EXE文件

EXE文件中包含了：1.再配置信息 2. 变量组 3. 函数组

当点击可执行文件时，加载到内存中运行时，在这其中函数、变量分配的是虚拟的内存地址空间。

链接器会在EXE文件的开头追加转换内存地址必要信息，并且链接后变量函数会变成一个连续的排列，然后通过基地址+偏移量的形式进行访问。

此外，在加载时会额外生成**堆和栈**两个组。

- *栈*中存放了函数内部临时使用的变量信息，函数调用所用的参数的内存区域

- 栈中数据存储与丢弃代码是由编译器自动生成的，每当函数被调用申请分配内存，用完后会自动释放。

- 堆中存放时程序运行时任意的数据以及对象内存区域，由程序员自由申请和释放，因此需要注意，避免内存泄漏问题。

  

