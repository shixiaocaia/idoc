Gorm框架
===

**[读文档](https://gorm.io/zh_CN/docs/index.html)**

## 什么是gorm

GORM让你的数据库里面的表结构变成你代码定义的数据结构（golang里面的结构体的结构）从而做到，代码结构即为数据库结构，代码行为即为数据库行为。

- 数据库的连接(以/YSQL为例)以及建表和自动迁移
- 模型建立
- 单表的增删改查
- 一对一关系一对多多对多关系的增删改查
- 特殊的增删改查(select原生sq等)
- 事务的操作(普通事务，嵌套事务)
- 自定义数据类型json[1,2,3]
- 钩子(生命周期HOOK函数)
- DBResolver读写分离（多数据库）

### 安装GORM

```go
go get -u gorm.io/gorm
go get -u gorm.io/driver/sqlite
```

### 链接MySQL

```go
db, _ := gorm.Open(mysql.New(mysql.Config{
    DSN: "root:1127@tcp(127.0.0.1:3306)/gorm_class?charset=utf8mb4&parseTime=True&loc=Local",
    DefaultStringSize: 256,
}), &gorm.Config{
    SkipDefaultTransaction: true,
    NamingStrategy: schema.NamingStrategy{
        TablePrefix:   "gva_", 
        SingularTable: false,  		// skip the snake_casing of names
    },
    DisableForeignKeyConstraintWhenMigrating: true, // 主张逻辑外键
})
```

- 学习gorm.Config设置，有一些设置需要提前设置好
  - DefaultStringSize
  - 跳过默认事务：SkipDefaultTransaction
  - 命名规则：NamingStrategy
  - 主张逻辑外键：DisableForeignKeyConstraintWhenMigrating

```go
sqlDB, _ := db.DB()
sqlDB.SetConnMaxIdleTime(10)
sqlDB.SetMaxOpenConns(100)
sqlDB.SetConnMaxLifetime(time.Hour)
```

- 配置连接池

### 建表以及关键api

```go
type User struct {
    Name string
}

type UserTwo struct {
    Name string
}

M := db.Migrator()
//M.CreateTable(&User{})
if M.HasTable(&User{}) {
    //M.DropTable(&User{})
    M.RenameTable(&User{}, &UserTwo{})
} else {
    M.RenameTable(&UserTwo{}, &User{})
}
```

- db.AutoMigrate(User)自动迁移（自动建表）
- Migrator接口一个统一的api接口
  - CreateTable(&结构体)创建表
  - HasTable是否存在表
  - DropTable删除表
  - RenameTable重命名表



