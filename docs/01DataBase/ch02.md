MySQL是怎么运行的
===

## 客户端和服务器连接

运行着的MySQL的服务端和客户端程序实际上都是计算机中的一个**进程**，所以客户端进程向服务器进程发送请求并得到回复的过程本质上是一个进程间通信的过程。

### TCP/IP

真实环境中，服务端和客户端是运行在不同的主机中，因此之间通信需要网络。MySQL采用的是**TCP**作为服务器和客户端之间的网络通信协议。

如果某个进程有需要采用 TCP 协议进行网络通信方面的需求，可以向操作系统申请一个端口号。这样在网络中的其他进程就可以通过**IP地址 + 端口号**的方式来与这个进程连接。

MySQL默认是使用3306端口号，当被占用或者想要自定义时，可以使用`-p`添加自定义端口号。

### 命名管道和共享内存

如果你是一个 Windows 用户，那么客户端进程和服务器进程之间可以考虑使用 **命名管道** 或 **共享内存** 进行通 信。

使用**共享内存**方式进行通信的，服务端和客户端必须在同一台Windows主机中。

### Unix域套接字文件

如果我们的服务器进程和客户端进程都运行在同一台操作系统为**类 Unix** 的机器上的话，我们可以使用 Unix域套 接字文件 来进行进程间通信。

## 服务器处理客户端请求

其实不论客户端进程和服务器进程是采用哪种方式进行通信，最后实现的效果都是：客户端进程向服务器进程发 送一段文本（MySQL语句），服务器进程处理后再向客户端进程发送一段文本（处理结果）。

### 连接管理

客户端连接可以采用上述三种方式，每当有一个客户端进程连接到服务器进程时，服务器进程都会创建一个**线程**来专门处理与客户端的交互。

当客户端断开与服务器之间连接时，服务器并不会立即把与该客户端交互的线程销毁掉，而 是把它缓存起来，在另一个新的客户端再进行连接时，把这个缓存的线程分配给该新客户端。这样就起到了不频繁创建和销毁线程的效果，从而节省开销。

此外每次连接都会创建线程，线程分配过多会影响系统性能，所以我们需要限制一下可以同时连接到服务器的客户端的数量。

进行连接时，需要提供用户名、密码等信息进行认证，如果认证失败，服务器程序会拒绝连接。如果不在一台计算上，我们还可以采用**SSL（安全套接字）**的网络连接进行通信，来保证数据传输的安全性。

### 解析与优化

在连接建立后，服务器只是收到了文本消息。还需要进行解析和优化。

MySQL服务器程序处理查询请求时，会把刚刚处理过的查询请求和结果**缓存**起来，发现相同的请求时，直接从缓存中查找结果，并且**在不同客户端之间共享**。

但是这样的缓存，会因为任务字符的不同，导致缓存不命中，另外如果查询请求中包含了某些系统函数，用户自定义变量和函数，那个查询请求不会缓存。

当MySQL的缓存系统会检测涉及到每张表的变化，只要该表的结构或者数据被修改，那么对该表的所有高速缓存查询都会变为无效，并从缓存中删除，**缓存失效**。

> 查询缓存提高了系统性能，但是维护缓存也会造成开销，从MySQL 8.0中已经删除查询缓存。

如果缓存没有命中，就要进入正式的查询，解析客户端发来的请求文本内容。

解析完成后，服务器程序获得到了需要的信息，由于我们写的SQL语句执行效率可能不高，还需要进一步优化，MySQL优化程序会执行一系列操作。

### 存储引擎

截止到服务器程序完成了查询优化为止，还没有真正的去访问真实的数据表， MySQL 服务器把数据的存储和提取 操作都封装到了一个叫 **存储引擎** 的模块里。我们知道 表 是由一行一行的记录组成的，但这只是一个逻辑上的概 念，物理上如何表示记录，怎么从表中读取数据，怎么把数据写入具体的物理存储器上，这都是 存储引擎 负责
的事情。

不同的**存储引擎**管理的表具体的存储结构可能不同，采取的存储算法也可能不同。

比较常用的是**InnoDB**和**MyISAM**，有时候会提一下**Memory**。

> InnoDB：具备外键支持功能的事务存储引擎。
>
> MyISAM：主要的非事物处理存储引擎。
>
> MEMORY：置于内存的表。

```mysql
show engines; # 查看当前服务器程序支持的存储引擎
```

Transactions 列代表该存储引擎是否支持事务处理。 XA 列代 表着该存储引擎是否支持分布式事务。 Savepoints 代表着该列是否支持部分事务回滚。
