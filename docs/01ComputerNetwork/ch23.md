TCP 三次握手与四次挥手
===

## 什么是TCP，什么是TCP连接

TCP 是**面向连接的、可靠的、基于字节流**的传输层通信协议。

- 面向连接：
- 可靠的：
- 字节流：

TCP连接，**用于保证可靠性和流量控制维护的某些状态信息，这些信息的组合，包括 Socket、序列号和窗口大小称为连接。**

## TCP头格式有哪些

![TCP 头格式](http://pic.shixiaocaia.fun/202303201628435.png)

- **序列号**：

- **确认应答号**：

- **控制位**：
  - ACK：
  - RST：
  - SYN：
  - FIN：

## 为什么需要TCP协议？TCP工作在哪一层

`IP` 层是「不可靠」的，它不保证网络包的交付、不保证网络包的按序交付、也不保证网络包中的数据的完整性。

如果需要保障网络数据包的可靠性，那么就需要由上层（传输层）的 `TCP` 协议来负责。

因为 TCP 是一个工作在**传输层**的**可靠**数据传输的服务，它能确保接收端接收的网络包是**无损坏、无间隔、非冗余和按序的。**

## 如何唯一确定一个TCP连接

TCP 四元组可以唯一的确定一个连接，四元组包括源地址和目的地址放在IP报文中，源端口和目的端口存放在TCP头部当中。

源地址和目的地址区分设备地址，而进程号则具体区分设备中的某个进程。

**有一个IP的服务端监听了一个端口，它的TCP的最大连接数是多少**

> 服务器端口通常固定在某个本地端口上监听，等待客户端的连接请求。
>
> 变化的是客户端IP和端口，理论上最大的TCP连接数 = 客户端的IP数 × 客户端端口数
>
> 对 IPv4，客户端的 IP 数最多为 `2` 的 `32` 次方，客户端的端口数最多为 `2` 的 `16` 次方，也就是服务端单机最大 TCP 连接数，约为 `2` 的 `48` 次方。
>
> 当然，服务端最大并发 TCP 连接数远不能达到理论上限，会受以下因素影响：
>
> - 文件描述符限制每个 TCP 连接都是一个文件，如果文件描述符被占满了，会发生 Too many open files。Linux 对可打开的文件描述符的数量分别作了三个方面的限制：
>   - **系统级**：当前系统可打开的最大数量，通过 `cat /proc/sys/fs/file-max` 查看；
>   - **用户级**：指定用户可打开的最大数量，通过 `cat /etc/security/limits.conf` 查看；
>   - **进程级**：单个进程可打开的最大数量，通过 `cat /proc/sys/fs/nr_open` 查看；
> - **内存限制**，每个 TCP 连接都要占用一定内存，操作系统的内存是有限的，如果内存资源被占满后，会发生 OOM。

