## 用单台虚拟主机实现多个域名

HTTP/1.1 规范允许一台 HTTP 服务器搭建多个 Web 站点。比如，提供 Web 托管服务（Web Hosting Service）的供应商，可以用一台服务器为多位客户服务，也可以以每位客户持有的域名运行各自不同的网站。

一台服务器对应一个IP地址，但是可以托管多个域名，由于虚拟主机可以寄存多个不同主机名和域名 的 Web 网站，因此在发送 HTTP 请求时，必须在 Host 首部内完整指定主机名或域名的 URI。

## 通信数据转发程序 ：代理、网关、隧道

HTTP 通信时，除客户端和服务器以外，还有一些用于通信数据转发 的应用程序，例如代理、网关和隧道。它们可以配合服务器工作。

这些应用程序和服务器可以将请求转发给通信线路上的下一站服务器，并且能接收从那台服务器发送的响应再转发给客户端。

### 代理

代理是一种有转发功能的应用程序，它扮演了位于服务器和客户 端“中间人”的角色，接收由客户端发送的请求并转发给服务器，同时也接收服务器返回的响应并转发给客户端。

代理不改变请求 URI，会直接发送给前方持有资源的目标服务器。

<img src="http://pic.shixiaocaia.fun/202301301046323.png" alt="image-20221120100644233" style="zoom:50%;" />

每次通过代理服务器转发请求或响应时，会追加写入 Via 首部信息，表示经过的主机。

> 使用代理服务器的理由有：利用缓存技术（稍后讲解）减少网络带宽 的流量，组织内部针对特定网站的访问控制，以获取访问日志为主要目的，等等。

**缓存代理**

代理转发响应时，缓存代理（Caching Proxy）会预先将资源的副本 （缓存）保存在代理服务器上。

当代理再次接收到对相同资源的请求时，就可以不从源服务器那里获取资源，而是将之前缓存的资源作为响应返回。

当然缓存服务器上的缓存也是具有时效性的，超过时效性，会要求重新获取。

此外客户端也具有缓存，称为临时网络文件。

**透明代理**

转发请求或响应时，不对报文做任何加工的代理类型被称为透明代理 （Transparent Proxy）。反之，对报文内容进行加工的代理被称为非透明代理。

### 网关

**网关是转发其他服务器通信数据的服务器**，接收从客户端发送来的请 求时，它就像自己拥有资源的源服务器一样对请求进行处理。有时客户端可能都不会察觉，自己的通信目标是一个网关。

网关能使通信线路上的服务器提供非 HTTP 协议服务，提供不同协议通信的转换。

> 利用网关能提高通信的安全性，因为可以在客户端与网关之间的通信 线路上加密以确保连接的安全。

### 隧道

隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序。

> 隧道的目的是确保客户端能与服务器进行安全的通信。
>
> 隧道本身不会去解析 HTTP 请求。也就是说，请求保持原样中转给之 后的服务器。隧道会在通信双方断开连接时结束。

## HTTP首部

### 报文首部

首部内容为客户端和服务器分别处理请求和响应提供所需要的信息。

> 请求报文，包括方法，URI，HTTP版本，请求首部字段，通用首部字段，实体首部字段。

> 响应报文，包括HTTP版本，状态码，响应首部字段，通用首部字段，实体首部字段。

### 首部字段

传递额外重要信息。使用首部字段是为了给浏览器和服务器提供报文主体大小、所使用的 语言、认证信息等内容。

主要分为通用首部字段、请求首部字段、响应首部字段、实体首部字段。

**End-to-end 首部和 Hop-by-hop 首部**

端到端首部（End-to-end Header） 

分在此类别中的首部会转发给请求 / 响应对应的最终接收目标，且必须保存在由缓存生成的响应中，另外规定它必须被转发。

逐跳首部（Hop-by-hop Header）
分在此类别中的首部只对单次转发有效，会因通过缓存或代理而不再转发。HTTP/1.1 和之后版本中，如果要使用 hop-by-hop 首部，需提供 Connection 首部字段。

主要包括以下的逐跳首部：

- Connection 
- Keep-Alive 
- Proxy-Authenticate
- Proxy-Authorization
- Trailer
- TE 
- Transfer-Encoding
- Upgrade

## HTTPS对比HTTP

HTTP主要有以下的不足：

1. 通信使用明文（不加密），内容可能会被窃听
2.  不验证通信方的身份，因此有可能遭遇伪装
3. 无法证明报文的完整性，所以有可能已遭篡改

> 使用MD5和SHA-1等散列值校验方法，确认文件的数字签名，保证报文的完整性。
>
> 因此使用HTTP + SSL传输文件，防止上述的弊端，SSL提供认证和加密处理和摘要等功能。

**HTTPS比HTTP要慢2到100倍**

SSL 的慢分两种。一种是指通信慢。另一种是指由于大量消耗 CPU 及内存等资源，导致处理速度变慢。

> 通信慢是要进行SSL通信部分。
>
> 其次要使用服务器客户端双方的加密解密步骤，占用系统资源。

考虑到上述的问题，还有HTTPS证书需要购买，非敏感信息使用HTTP传输。

## 什么是HTTPS

HTTPS = HTTP + 通信加密 + 证书 + 完整性保护。

HTTPS并不是一种新的应用层协议，只是在HTTP通信接口上用SSL + TLS协议代替的。

有了SSL，应用层的HTTP先和SSL通信，SSL再和TCP通信。

SSL是独立于HTTP的，因此其他协议例如SMTP等均可使用SSL这样的网络安全技术。

### SSL

SSL采用一种**公开密钥加密**的加密处理方式。

近代的加密方法中加密算法是公开的，密钥却是保密的，通过这种方式以保持加密方式的安全性。

公开密钥加密方式使用了一堆**非对称**的密钥。一把叫做**私有密钥**，一把叫做**公开密钥**。

发送密文的一方使用对方的公开密钥进 行加密处理，对方收到被加密的信息后，再使用自己的私有密钥
进行解密。

> HTTPS 采用共享密钥加密和公开密钥加密两者并用的混合加密机制。
>
> 在交换密钥环节使用公开密钥加密方式，之后的建立通信交换报文阶段则使用共享密钥加密方式。

### 证书

为了证明接收到的公开密钥未被替换，而有了**公开密钥证书**，由数字证书认证机构（CA，Certificate Authority）和其相关机关颁发。

> 1. 服务器把自己的公开密钥登陆到CA当中。
> 2. CA用自己的私有密钥向那个公开密钥签署数字签名，公开密钥 + 数字签名变成了公钥证书。
> 3. 客户端拿到证书后，使用CA的公开密钥向CA查询数字签名，证明公钥的真实性。
> 4. 使用服务器的公钥、私钥进行通信。

## HTTP/1.1 使用的认证方式

认证访问者或者说登陆者的身份。

### BASIC

当请求的资源需要 BASIC 认证时，服务器会随状态码 `401 Authorization Required`，返回带 WWW-Authenticate 首部字段的响应。

接收到状态码的客户端通过BASIC认证，将用户ID及密码发送给服务器，此类字符串信息要经过Base64编码处理。

BASIC认证虽然采用了Base64编码，但是任何人都可以进行解码，实际中安全等级是不够的，仍属于明文密码。

### DIGEST

从HTTP / 1.1开始有DIGEST认证。

使用质询响应方式，发送给对方的只是**响应摘要**及由**质询码产生的计算结果**，所以比 起 BASIC 认证，密码泄露的可能性就降低了。

客户端接收到质疑码后，返回响应包含 DIGEST 认 证必须的首部字段 Authorization 信息，首部字段Authorization 内必须包含 username、realm、nonce、uri 和 response 的字段信息。其中，realm 和 nonce 就是之前从服务器接收到的响应中的字段。

### SSL客户端认证

SSL 客户端认证是借由 HTTPS 的客户端证书完成认证的方式。服务器可确认访问是否来自己登陆的客户端。

服务器要求客户端安装客户端证书，客户端安装后发送证书信息，服务端从中提取公钥信息。

SSL客户端认证采用双因素认证，第一个认证因素的 SSL 客户端证书用来认证客户端计算机， 另一个认证因素的密码则用来确定这是用户本人的行为。

### 基于表单认证

客户端会向服务 器上的 Web 应用程序发送登录信息（Credential），按登录信息的验证结果认证。

> 由于使用上的便利性及安全性问题，HTTP 协议标准提供的 BASIC 认 证和 DIGEST 认证几乎不怎么使用。另外，SSL 客户端认证虽然具有高度的安全等级，但因为导入及维持费用等问题，还尚未普及。

## 基于HTTP的功能追加协议

### SPYD

Google在2010年发布了 SPYD，其开发目标旨在解决 HTTP 的性能瓶颈，缩短 Web 页面的加载时间。要求使用SSL。

SPDY 以会话层的形式加入，控制对数据的流动，但还是采用 HTTP 建立通信连接，介于HTTP和SSL之间。

> 使用SPYD后，HTTP协议获得以下额外功能
>
> 1. 多路复用流
> 2. 赋予请求优先级
> 3. 压缩HTTP首部
> 4. 推送功能
> 5. 服务器提示功能

### WebSocket

WebSocket，基于HTTP通信，即 Web 浏览器与 Web 服务器之间**全双工通信**标准。

利用 Ajax 和 Comet 技术进行通信可以提升 Web 的浏览速度。但问题在于通信若使用 HTTP 协议，就无法彻底解决瓶颈问题。WebSocket网络技术正是为解决这些问题而实现的一套新协议及 API。

> Ajax解决方法，一种有效利用 JavaScript 和 DOM（Document Object Model，文 档对象模型）的操作，以达到局部 Web 页面替换加载的异步通信手段。
>
> Comet解决办法，一旦服务器端有内容更新了，Comet 不会让请求等待，而是直接给客 户端返回响应。这是一种通过延迟应答，模拟实现服务器端向客户端推送（Server Push）的功能。

一旦 Web 服务器与客户端之间建立起 WebSocket 协议的通信连接， 之后所有的通信都依靠这个专用协议进行。通信过程中可互相发送JSON、XML、HTML 或图片等任意格式的数据。

为了实现WebSocket通信，需要在HTTP连接建立之后，完成一次握手的操作，用Upgrade切换到WebSocket协议。

