IP知识全家桶
===

## IP的基本认识

IP 在 TCP/IP 参考模型中处于第三层，也就是*网络层*。

网络层的主要作用是：实现主机与主机之间的通信，也叫*点对点（end to end）通信*。

> 网络层与数据链路层有什么关系呢？
>
> - IP(网络层)用于实现主机与主机之间的通信
>
> - MAC(数据链路层)实现「直连」的两个设备之间通信。

在网络中数据包传输中也是如此，源IP地址和目标IP地址在传输过程中是不会变化的（前提：没有使用 NAT 网络），只有源 MAC 地址和目标 MAC 一直在变化。

## IP地址的基础知识

在 TCP/IP 网络通信时，为了保证能正常通信，每个设备都需要配置正确的 IP 地址，否则无法实现正常的通信。

IP 地址（IPv4 地址）由 `32` 位正整数来表示，IP 地址在计算机是以二进制的方式处理的。

而人类为了方便记忆采用了**点分十进制**的标记方式，也就是将 32 位 IP 地址以每 8 位为组，共分为 `4` 组，每组以「`.`」隔开，再将每组转换成十进制。

理论上32位的IP地址只能够大约43亿计算机连接网络，但是实际中不是这样分配的，实际中是根据**网卡**分配IP地址。

### IP地址分类

#### ABCDE

最早IP 地址分类成了 5 种类型，分别是 A 类、B 类、C 类、D 类、E 类。

每个地址划分为网络号和地址号两部分。

> 网络号：负责标识该 IP 地址是属于哪个「子网」的；
>
> 主机号：负责标识同一「子网」下的不同主机，用来区分设备。

![](http://pic.shixiaocaia.fun/202301301043432.png)

每一类地址的最大主机数是根据主机号位数再减去(主机号)全0和全1的网络地址和广播地址。

> 广播地址用于在同一个链路中相互连接的主机之间发送数据包。
>
> 本地广播（本网络内）：网络地址为 192.168.0.0/24 向192.168.0.255/24
>
> 直接广播（跨网络）：网络地址为 192.168.0.0/24 向192.168.1.255/24

而 D 类和 E 类地址是没有主机号的，所以不可用于主机 IP，D 类常被用于**多播**，E 类是预留的分类，暂时未使用。

> 多播用于将包发送给特定组内的所有主机。

由于广播无法穿透路由，若想给其他网段发送同样的包，就可以使用可以穿透路由的多播。

> 1. IP分类后，有利于更快找到网络地址和主机地址。
> 2. 上述ABCDE分类后，在同一网络下不利于继续分类，缺少地址的灵活性，不同类的地址数量不能很好的适应地址需求。

#### 无分类地址地址 CIDR

这种方式不再有分类地址的概念，32 比特的 IP 地址被划分为两部分，前面是**网络号**，后面是**主机号**。

将子网掩码和 IP 地址按位计算 AND，就可得到网络号。

> 通过前面的网络号判断计算机是否在一个处于同一个广播域内，即网络地址是否相同。如果网络地址相同，表明接受方在本网络上，那么可以把数据包直接发送到目标主机。
>
> 路由器也是经过网络号来匹配转发到对应子网中。

通过子网掩码可以对子网在进行划分，对主机号进行划分使用。比如可以借两位主机号，从而将子网划分为四个段。

#### 公有IP地址和私有IP地址

往往我们在学校是使用的是私有IP地址，当我们访问网络时，网站那一段看到是一个公网IP地址来访问。

私有 IP 地址通常是内部的 IT 人员管理，公有 IP 地址是由 `ICANN` 组织管理，中文叫「互联网名称与数字地址分配机构」。

> **IPV4地址仍在使用的原因**
>
> 在实际中，我们会将网络分为广域网和局域网来表示更多的主机设备。
>
> - 同一个局域网内的设备对外使用同一个IP，称为公网IP，在局域网内部的设备IP地址通过路由器进行分配。
> - 此外，局域网内还能嵌套局域网，从而表示更多的主机设备。
> - 根据需要不同的公网IP数量，在选择合适的ABC类IP地址进行划分，常见的使用C类，那么IP地址的开头就是192.168开头。
>
> 由此，IPv4地址到现如今还在继续使用。

### IP地址和路由控制

IP地址的**网络地址**这一部分是用于进行路由控制，也可以说IP地址具有**路由选择**的功能。

路由控制表中记录着网络地址与下一步应该发送至路由器的地址。在主机和路由器上都会有各自的路由器控制表。

> IP地址分为网络地址和主机地址，进行子网划分后，又将部分的主机地址划分为子网网络地址和子网主机地址。
>
> 在进行路由选择时看的是纯网络地址的一部分。

![IP 地址与路由控制](http://pic.shixiaocaia.fun/202302141538221.png)

1. 主机 A 要发送一个 IP 包，其源地址是 `10.1.1.30` 和目标地址是 `10.1.2.10`，由于没有在主机 A 的路由表找到与目标地址 `10.1.2.10` 相同的网络地址，于是包被转发到默认路由（路由器 `1` ）
2. 路由器 `1` 收到 IP 包后，也在路由器 `1` 的路由表匹配与目标地址相同的网络地址记录，发现匹配到了，于是就把 IP 数据包转发到了 `10.1.0.2` 这台路由器 `2`
3. 路由器 `2` 收到后，同样对比自身的路由表，发现匹配到了，于是把 IP 包从路由器 `2` 的 `10.1.2.1` 这个接口出去，最终经过交换机把 IP 数据包转发到了目标主机

### 环回地址

环回地址是在同一台计算机上的程序之间进行网络通信时所使用的一个默认地址。

计算机使用一个特殊的 IP 地址 **127.0.0.1 作为环回地址**。与该地址具有相同意义的是一个叫做 `localhost` 的主机名。使用这个 IP 或主机名时，数据包不会流向网络。

### IP分片和重组

每种数据链路的最大传输单元 `MTU` 都是不相同的，如 FDDI 数据链路 MTU 4352、以太网的 MTU 是 1500 字节等。

每种数据链路的 MTU 之所以不同，是因为每个不同类型的数据链路的使用目的不同。使用目的不同，可承载的 MTU 也就不同。

那么当 IP 数据包大小大于 MTU 时， IP 数据包就会被分片。

经过分片之后的 IP 数据报在被重组的时候，只能由目标主机进行，路由器是不会进行重组的。

> 假设发送方发送一个 4000 字节的大数据报，若要传输在以太网链路，则需要把数据报分片成 3 个小数据报进行传输，再交由接收方重组成大数据报。

![分片与重组](http://pic.shixiaocaia.fun/202302141543486.jpeg)

在分片传输中，一旦某个分片丢失，则会造成整个 IP 数据报作废，所以 TCP 引入了 `MSS` 也就是在 TCP 层进行分片不由 IP 层分片，那么对于 UDP 我们尽量不要发送一个大于 `MTU` 的数据报文。

### IPv6基本认识

IPv4 的地址是 32 位的，大约可以提供 42 亿个地址，但是早在 2011 年 IPv4 地址就已经被分配完了。于是引入了128位的IPv6。

> 实际中我们还在使用IPv4，引入了广域网和局域网等机制。

由于IPv4 和 IPv6 不能相互兼容，所以不但要我们电脑、手机之类的设备支持，还需要网络运营商对现有的设备进行升级，所以这可能是 IPv6 普及率比较慢的一个原因。

#### IPv6优点

IPv6 不仅仅只是可分配的地址变多了，它还有非常多的亮点。

> - IPv6 可自动配置，即使没有 DHCP 服务器也可以实现自动分配IP地址，真是**便捷到即插即用**啊。
> - IPv6 包头包首部长度采用固定的值 `40` 字节，去掉了包头校验和，简化了首部结构，减轻了路由器负荷，大大**提高了传输的性能**。
> - IPv6 有应对伪造 IP 地址的网络安全功能以及防止线路窃听的功能，大大**提升了安全性**。

#### IPv6 地址的标识方法

IPv4 地址长度共 32 位，是以每 8 位作为一组，并用点分十进制的表示方式。

IPv6 地址长度是 128 位，是以每 16 位作为一组，每组用冒号 「:」 隔开。

如果出现连续的 0 时还可以将这些 0 省略，并用两个冒号 「::」隔开。但是，一个 IP 地址中只允许出现一次两个连续的冒号。

#### IPv6地址的结构

- 单播地址，用于一对一的通信
- 组播地址，用于一对多的通信
- 任播地址，用于通信最近的节点，最近的节点是由路由协议决定
- 没有广播地址

#### IPv4 首部与 IPv6 首部

![IPv4 首部与 IPv6 首部的差异](http://pic.shixiaocaia.fun/202302141551386.png)

IPv6 相比 IPv4 的首部改进：

- **取消了首部校验和字段。** 因为在数据链路层和传输层都会校验，因此 IPv6 直接取消了 IP 的校验。
- **取消了分片/重新组装相关字段。** 分片与重组是耗时的过程，IPv6 不允许在中间路由器进行分片与重组，这种操作只能在源与目标主机，这将大大提高了路由器转发的速度。
- **取消选项字段。** 选项字段不再是标准 IP 首部的一部分了，但它并没有消失，而是可能出现在 IPv6 首部中的「下一个首部」指出的位置上。删除该选项字段使的 IPv6 的首部成为固定长度的 `40` 字节。

## IP协议相关技术

### DNS

**域名**由若干个英文字符串组成（不区分大小写），各字符串之间用点号『.』分隔连接，其中越靠右的表示域名级别越高。域名级别最低的写在最左边。

> www.baidu.com
>
> 其中 *com* 是顶级域名（一级域名），*baidu* 是二级域名，*www* 是三级域名。

**域名服务器**（也称为 DNS 服务器）负责存储域名和 IP 地址的映射关系，当我们需要获取某个域名对应的 IP 地址时，只需要从域名服务器中查询即可。

由于域名非常非常多，如果都存放在一台域名服务器中，那么不仅查询速度慢，服务器压力大，而且难以保证服务的可靠性。因此，**DNS 采用了分布式的设计方案，大量的域名服务器之间通过`层次`方式组织，分布在全世界范围内。**

**域名解析流程**

![img](http://pic.shixiaocaia.fun/202302122034697.gif)

1. 请求主机向本地域名服务器发送 DNS 查询报文，询问 *www.baidu.com* 的 IP 地址是什么；
2. 本地域名服务器转发此查询报文到**根域名服务器**；
3. **根域名服务器**发现要查询的顶级域名为 *com*，于是向本地域名服务器发送响应报文，报文中封装了负责 *com* 域的顶级域名服务器的 IP 地址列表；
4. 本地域名服务器收到根域名服务器响应的报文后，选择其中一个**顶级域名服务器**的 IP 地址，并向其发送查询报文；
5. **顶级域名服务器**发现要查询的二级域名为 *baidu*，于是向本地域名服务器发送响应报文，报文中封装了负责*baidu.com* 域的权威域名服务器的 IP 地址列表；
6. 本地域名服务器收到顶级域名服务器响应的报文后，选择其中一个**权威域名服务器**的 IP 地址，并向其发送查询报文；
7. **权威域名服务器**通过查询数据库，找到 *www.baidau.com* 的 IP 地址，并将此信息封装为一个响应报文，发送给本地域名服务器；
8. 本地域名服务器将响应报文发送给原请求主机。我们的主机就知道了百度的 IP 地址，DNS 查询过程结束。

> 整个过程中，请求主机与本地域名服务器之间的交互称为`递归查询`，而本地域名服务器与域名服务器层次结构中相关服务器的交互称为`迭代查询`。
>
> 递归方式：从主机到本地（本区域服务器）去查询，然后去根域名服务器，顶级域名服务器，查到再向上返回。
>
> 迭代方式：不断告诉你去哪里查，及时反馈，再去下一个地方查，再反馈。

为了减轻服务器的负担，域名服务器（例如本地区服务器）使用了高速缓存，用来存放最近查询过的域名以及映射信息，这样就不用一级级查找了。

**请求主机是如何知道本地域名服务器的 IP 地址的？**

当用户插上网线或者连上 WIFI 后，电脑会通过 DHCP 协议分配一个 IP 地址，与此同时，也会获取到本地域名服务器的 IP 地址！

**本地域名服务器是如何知道根域名服务器的 IP 地址的？**

因特网上一共有 13 个根域名服务器，它们的 IP 地址是固定不变的，因此被集成在了操作系统中，每台电脑都知道！

为了解析出百度域名的 IP 地址，一共发送了 8 份 DNS 报文。用户本来只是想和百度的服务器进行交互，却耗费了大量的时间进行域名解析，**如果每次都这样搞，岂不是得慢死？因此就需要有一些提升域名解析速度的方式。**

**提升冲浪速度**

- DNS主要使用UDP，辅助域名服务器定时与主服务器交换信息实现同步，传输数据主要是TCP，UDP报文相比TC报文传输更快。
- 使用缓存技术，当用户访问了某个网站后，本地域名服务器会将解析出的域名和 IP 地址的映射关系缓存一定时间。**在缓存过期前，用户再访问相同网站时，本地域名服务器就可以直接返回查询结果**，而无需再去询问根域名服务器、顶级域名服务器等，这样就能大大减少传输的 DNS 报文数量！
- 切换本地域名服务器，防止自动获取的本地域名服务器过差。

### ARP

在网络当中光光靠着IP地址的路由选择，是不够的。

在传输一个 IP 数据报的时候，确定了源 IP 地址和目标 IP 地址后，就会通过主机「路由表」确定 IP 数据包下一跳。然而，网络层的下一层是数据链路层，所以我们还要知道「下一跳」的 MAC 地址。

由于主机的路由表中可以找到下一跳的 IP 地址，所以可以通过 **ARP 协议**，求得下一跳的 MAC 地址。

**如何获取MAC 地址**

简单地说，ARP 是借助 **ARP 请求与 ARP 响应**两种类型的包确定 MAC 地址的。

- 主机会通过**广播发送 ARP 请求**，这个包中包含了想要知道的 MAC 地址的主机 IP 地址。
- 当同个链路中的所有设备收到 ARP 请求时，会去拆开 ARP 请求包里的内容，如果 ARP 请求包中的目标 IP 地址与自己的 IP 地址一致，那么这个设备就将自己的 MAC 地址塞入 **ARP 响应包**返回给主机。

操作系统通常会把第一次通过 ARP 获取的 MAC 地址缓存起来，以便下次直接从缓存中找到对应 IP 地址的 MAC 地址。

> 不过，MAC 地址的缓存是有一定期限的，超过这个期限，缓存的内容将被清除。

### RARP

通过假设一个RARP 服务器，在这个服务器上注册设备的 MAC 地址及其 IP 地址。然后再将这个设备接入到网络，接着其他设备向该服务器发送包含自己MAC地址的请求信息，服务器返回对应的IP地址信息。

### DHCP

DHCP 在生活中我们是很常见的了，我们的电脑通常都是通过 DHCP 动态获取 IP 地址，大大省去了配 IP 信息繁琐的过程。

> IPv6中不需要经过DHCP分配。

![DHCP 工作流程](http://pic.shixiaocaia.fun/202302141605879.png)

- 客户端首先发起 **DHCP 发现报文（DHCP DISCOVER）** 的 IP 数据报，由于客户端没有 IP 地址，也不知道 DHCP 服务器的地址，所以使用的是 UDP **广播**通信，其使用的广播目的地址是 255.255.255.255（端口 67） 并且使用 0.0.0.0（端口 68） 作为源 IP 地址。DHCP 客户端将该 IP 数据报传递给链路层，链路层然后将帧广播到所有的网络中设备。
- DHCP 服务器收到 DHCP 发现报文时，用 **DHCP 提供报文（DHCP OFFER）** 向客户端做出响应。该报文仍然使用 IP 广播地址 255.255.255.255，该报文信息携带服务器提供可租约的 IP 地址、子网掩码、默认网关、DNS 服务器以及 **IP 地址租用期**。
- 客户端收到一个或多个服务器的 DHCP 提供报文后，从中选择一个服务器，并向选中的服务器发送 **DHCP 请求报文（DHCP REQUEST**进行响应，回显配置的参数。
- 最后，服务端用 **DHCP ACK 报文**对 DHCP 请求报文进行响应，应答所要求的参数。

一旦客户端收到 DHCP ACK 后，交互便完成了，并且客户端能够在租用期内使用 DHCP 服务器分配的 IP 地址。

如果租约的 DHCP IP 地址快期后，客户端会向服务器发送 DHCP 请求报文：

- 服务器如果同意继续租用，则用 DHCP ACK 报文进行应答，客户端就会延长租期。
- 服务器如果不同意继续租用，则用 DHCP NACK 报文，客户端就要停止使用租约的 IP 地址。

#### DHCP中继代理

DHCP 交互中，**全程都是使用 UDP 广播通信**。如果 DHCP 服务器和客户端不是在同一个局域网内，路由器又不会转发广播包，那不是每个网络都要配一个 DHCP 服务器？

所以，为了解决这一问题，就出现了 **DHCP 中继代理**。有了 DHCP 中继代理以后，**对不同网段的 IP 地址分配也可以由一个 DHCP 服务器统一进行管理。**

![ DHCP 中继代理](http://pic.shixiaocaia.fun/202302141608732.jpeg)

- DHCP 客户端会向 DHCP 中继代理发送 DHCP 请求包，而 DHCP 中继代理在收到这个广播包以后，再以**单播**的形式发给 DHCP 服务器。
- 服务器端收到该包以后再向 DHCP 中继代理返回应答，并由 DHCP 中继代理将此包广播给 DHCP 客户端 。

因此，DHCP 服务器即使不在同一个链路上也可以实现统一分配和管理IP地址。

### NAT

### ICMP

### IGMP

